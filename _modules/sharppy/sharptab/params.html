

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>sharppy.sharptab.params &mdash; SHARPpy 1.4.0b1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> SHARPpy
          

          
          </a>

          
            
            
              <div class="version">
                1.4.0b1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../picker.html">Running SHARPpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../interpreting_gui.html">Interpreting the GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../insets.html">Interpreting the Insets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../interacting_gui.html">Interacting with the GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../datasource_guide.html">Custom Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scripting.html">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Example scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../citing.html">Citing</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SHARPpy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>sharppy.sharptab.params</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sharppy.sharptab.params</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&#39;&#39;&#39; Thermodynamic Parameter Routines &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
<span class="kn">from</span> <span class="nn">sharppy.sharptab</span> <span class="kn">import</span> <span class="n">interp</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">thermo</span><span class="p">,</span> <span class="n">winds</span>
<span class="kn">from</span> <span class="nn">sharppy.sharptab.constants</span> <span class="kn">import</span> <span class="o">*</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This file contains various functions to perform the calculation of various convection indices.</span>
<span class="sd">    Because of this, parcel lifting routines are also found in this file.</span>

<span class="sd">    Functions denoted with a (*) in the docstring refer to functions that were added to the SHARPpy package that </span>
<span class="sd">    were not ported from the Storm Prediction Center.  They have been included as they have been used by the </span>
<span class="sd">    community in an effort to expand SHARPpy to support the many parameters used in atmospheric science. </span>
<span class="sd">    </span>
<span class="sd">    While the logic for these functions are based in the scientific literature, validation</span>
<span class="sd">    of the output from these functions is occasionally difficult to perform.  Although we have made an effort</span>
<span class="sd">    to resolve code issues when they arise, values from these functions may be erronious and may require additional </span>
<span class="sd">    inspection by the user.  We appreciate any contributions by the meteorological community that can</span>
<span class="sd">    help better validate these SHARPpy functions!</span>
<span class="sd">    </span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DefineParcel&#39;</span><span class="p">,</span> <span class="s1">&#39;Parcel&#39;</span><span class="p">,</span> <span class="s1">&#39;inferred_temp_advection&#39;</span><span class="p">]</span>
<span class="n">__all__</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;k_index&#39;</span><span class="p">,</span> <span class="s1">&#39;t_totals&#39;</span><span class="p">,</span> <span class="s1">&#39;c_totals&#39;</span><span class="p">,</span> <span class="s1">&#39;v_totals&#39;</span><span class="p">,</span> <span class="s1">&#39;precip_water&#39;</span><span class="p">]</span>
<span class="n">__all__</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;temp_lvl&#39;</span><span class="p">,</span> <span class="s1">&#39;max_temp&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_mixratio&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_theta&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_thetae&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_relh&#39;</span><span class="p">]</span>
<span class="n">__all__</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;lapse_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;max_lapse_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;most_unstable_level&#39;</span><span class="p">,</span> <span class="s1">&#39;parcelx&#39;</span><span class="p">,</span> <span class="s1">&#39;bulk_rich&#39;</span><span class="p">]</span>
<span class="n">__all__</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;bunkers_storm_motion&#39;</span><span class="p">,</span> <span class="s1">&#39;effective_inflow_layer&#39;</span><span class="p">]</span>
<span class="n">__all__</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;convective_temp&#39;</span><span class="p">,</span> <span class="s1">&#39;esp&#39;</span><span class="p">,</span> <span class="s1">&#39;pbl_top&#39;</span><span class="p">,</span> <span class="s1">&#39;precip_eff&#39;</span><span class="p">,</span> <span class="s1">&#39;dcape&#39;</span><span class="p">,</span> <span class="s1">&#39;sig_severe&#39;</span><span class="p">]</span>
<span class="n">__all__</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;dgz&#39;</span><span class="p">,</span> <span class="s1">&#39;ship&#39;</span><span class="p">,</span> <span class="s1">&#39;stp_cin&#39;</span><span class="p">,</span> <span class="s1">&#39;stp_fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;scp&#39;</span><span class="p">,</span> <span class="s1">&#39;mmp&#39;</span><span class="p">,</span> <span class="s1">&#39;wndg&#39;</span><span class="p">,</span> <span class="s1">&#39;sherb&#39;</span><span class="p">,</span> <span class="s1">&#39;tei&#39;</span><span class="p">,</span> <span class="s1">&#39;cape&#39;</span><span class="p">]</span>
<span class="n">__all__</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;mburst&#39;</span><span class="p">,</span> <span class="s1">&#39;dcp&#39;</span><span class="p">,</span> <span class="s1">&#39;ehi&#39;</span><span class="p">,</span> <span class="s1">&#39;sweat&#39;</span><span class="p">,</span> <span class="s1">&#39;hgz&#39;</span><span class="p">,</span> <span class="s1">&#39;lhp&#39;</span><span class="p">,</span> <span class="s1">&#39;integrate_parcel&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="DefineParcel"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.DefineParcel">[docs]</a><span class="k">class</span> <span class="nc">DefineParcel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create a parcel from a supplied profile object.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        </span>
<span class="sd">        Optional Keywords</span>
<span class="sd">            flag : int (default = 1)</span>
<span class="sd">            Parcel Selection</span>

<span class="sd">        1 - Observed Surface Parcel</span>
<span class="sd">        2 - Forecast Surface Parcel</span>
<span class="sd">        3 - Most Unstable Parcel</span>
<span class="sd">        4 - Mean Mixed Layer Parcel</span>
<span class="sd">        5 - User Defined Parcel</span>
<span class="sd">        6 - Mean Effective Layer Parcel</span>
<span class="sd">        </span>
<span class="sd">        Optional Keywords (Depending on Parcel Selected)</span>
<span class="sd">        Parcel (flag) == 1: Observed Surface Parcel</span>
<span class="sd">            None</span>

<span class="sd">        Parcel (flag) == 2: Forecast Surface Parcel</span>
<span class="sd">        pres : number (default = 100 hPa)</span>
<span class="sd">            Depth over which to mix the boundary layer; only changes</span>
<span class="sd">            temperature; does not affect moisture</span>

<span class="sd">        Parcel (flag) == 3: Most Unstable Parcel</span>
<span class="sd">        pres : number (default = 400 hPa)</span>
<span class="sd">            Depth over which to look for the the most unstable parcel</span>
<span class="sd">        starting from the surface pressure</span>
<span class="sd">            Parcel (flag) == 4: Mixed Layer Parcel</span>
<span class="sd">        pres : number (default = 100 hPa)</span>
<span class="sd">            Depth over which to mix the surface parcel</span>

<span class="sd">        Parcel (flag) == 5: User Defined Parcel</span>
<span class="sd">        pres : number (default = SFC - 100 hPa)</span>
<span class="sd">            Pressure of the parcel to lift</span>
<span class="sd">        tmpc : number (default = Temperature at the provided pressure)</span>
<span class="sd">            Temperature of the parcel to lift</span>
<span class="sd">        dwpc : number (default = Dew Point at the provided pressure)</span>
<span class="sd">            Dew Point of the parcel to lift</span>

<span class="sd">        Parcel (flag) == 6: Effective Inflow Layer</span>
<span class="sd">        ecape : number (default = 100)</span>
<span class="sd">            The minimum amount of CAPE a parcel needs to be considered</span>
<span class="sd">            part of the inflow layer</span>
<span class="sd">        ecinh : number (default = -250)</span>
<span class="sd">            The maximum amount of CINH allowed for a parcel to be</span>
<span class="sd">            considered as part of the inflow layer</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">presval</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__sfc</span><span class="p">(</span><span class="n">prof</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">presval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pres&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fcst</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">presval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pres&#39;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__mu</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">presval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pres&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ml</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">presval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pres&#39;</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__user</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">presval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pres&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__effective</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">presval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pres&#39;</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">gSndg</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__sfc</span><span class="p">(</span><span class="n">prof</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">__sfc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prof</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Create a parcel using surface conditions</span>
<span class="sd">            </span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Surface Parcel&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pres</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwpc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    
    
    <span class="k">def</span> <span class="nf">__fcst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Create a parcel using forecast conditions.</span>
<span class="sd">            </span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Forecast Surface Parcel&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpc</span> <span class="o">=</span> <span class="n">max_temp</span><span class="p">(</span><span class="n">prof</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pres</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
        <span class="n">pbot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pres</span><span class="p">;</span> <span class="n">ptop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pres</span> <span class="o">-</span> <span class="mf">100.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwpc</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">temp_at_mixrat</span><span class="p">(</span><span class="n">mean_mixratio</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">__mu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Create the most unstable parcel within the lowest XXX hPa, where</span>
<span class="sd">            XXX is supplied. Default XXX is 400 hPa.</span>
<span class="sd">            </span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Most Unstable Parcel in Lowest </span><span class="si">%.2f</span><span class="s1"> hPa&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">presval</span>
        <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
        <span class="n">ptop</span> <span class="o">=</span> <span class="n">pbot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">presval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pres</span> <span class="o">=</span> <span class="n">most_unstable_level</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">ptop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpc</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwpc</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">__ml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Create a mixed-layer parcel with mixing within the lowest XXX hPa,</span>
<span class="sd">            where XXX is supplied. Default is 100 hPa.</span>

<span class="sd">            If</span>
<span class="sd">            </span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1"> hPa Mixed Layer Parcel&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">presval</span>
        <span class="n">pbot</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pbot&#39;</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">])</span>
        <span class="n">ptop</span> <span class="o">=</span> <span class="n">pbot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">presval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pres</span> <span class="o">=</span> <span class="n">pbot</span>
        <span class="n">mtheta</span> <span class="o">=</span> <span class="n">mean_theta</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpc</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">mtheta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
        <span class="n">mmr</span> <span class="o">=</span> <span class="n">mean_mixratio</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwpc</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">temp_at_mixrat</span><span class="p">(</span><span class="n">mmr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">__user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Create a user defined parcel.</span>
<span class="sd">            </span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1"> hPa Parcel&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">presval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tmpc&#39;</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pres</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwpc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dwpc&#39;</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pres</span><span class="p">))</span>
    
    
    <span class="k">def</span> <span class="nf">__effective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Create the mean-effective layer parcel.</span>
<span class="sd">            </span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="n">ecape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ecape&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">ecinh</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ecinh&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">250</span><span class="p">)</span>
        <span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span> <span class="o">=</span> <span class="n">effective_inflow_layer</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ecape</span><span class="p">,</span> <span class="n">ecinh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pbot</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pbot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1"> hPa Mean Effective Layer Centered at </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">pbot</span><span class="o">-</span><span class="n">ptop</span><span class="p">,</span> <span class="p">(</span><span class="n">pbot</span><span class="o">+</span><span class="n">ptop</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">mtha</span> <span class="o">=</span> <span class="n">mean_theta</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)</span>
            <span class="n">mmr</span> <span class="o">=</span> <span class="n">mean_mixratio</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pres</span> <span class="o">=</span> <span class="p">(</span><span class="n">pbot</span><span class="o">+</span><span class="n">ptop</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmpc</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">mtha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dwpc</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">temp_at_mixrat</span><span class="p">(</span><span class="n">mmr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Defaulting to Surface Layer&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pres</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmpc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dwpc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pbot</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbot</span> <span class="o">=</span> <span class="n">pbot</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbot</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">ptop</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptop</span> <span class="o">=</span> <span class="n">ptop</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbot</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span></div>


<div class="viewcode-block" id="Parcel"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.Parcel">[docs]</a><span class="k">class</span> <span class="nc">Parcel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialize the parcel variables</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pbot : number</span>
<span class="sd">            Lower-bound (pressure; hPa) that the parcel is lifted</span>
<span class="sd">        ptop : number</span>
<span class="sd">            Upper-bound (pressure; hPa) that the parcel is lifted</span>
<span class="sd">        pres : number</span>
<span class="sd">            Pressure of the parcel to lift (hPa)</span>
<span class="sd">        tmpc : number</span>
<span class="sd">            Temperature of the parcel to lift (C)</span>
<span class="sd">        dwpc : number</span>
<span class="sd">            Dew Point of the parcel to lift (C)</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        pres : number</span>
<span class="sd">            parcel beginning pressure (mb)</span>
<span class="sd">        tmpc : number</span>
<span class="sd">            parcel beginning temperature (C)</span>
<span class="sd">        dwpc : number</span>
<span class="sd">            parcel beginning dewpoint (C)</span>
<span class="sd">        ptrace : array</span>
<span class="sd">            parcel trace pressure (mb)</span>
<span class="sd">        ttrace : array</span>
<span class="sd">            parcel trace temperature (C)</span>
<span class="sd">        blayer : number</span>
<span class="sd">            Pressure of the bottom of the layer the parcel is lifted (mb)</span>
<span class="sd">        tlayer : number</span>
<span class="sd">            Pressure of the top of the layer the parcel is lifted (mb)</span>
<span class="sd">        entrain : number</span>
<span class="sd">            Parcel entrainment fraction (not yet implemented)</span>
<span class="sd">        lclpres : number</span>
<span class="sd">            Parcel LCL (lifted condensation level) pressure (mb)</span>
<span class="sd">        lclhght : number</span>
<span class="sd">            Parcel LCL height (m AGL)</span>
<span class="sd">        lfcpres : number</span>
<span class="sd">            Parcel LFC (level of free convection) pressure (mb)</span>
<span class="sd">        lfchght: number</span>
<span class="sd">            Parcel LCL height (m AGL)</span>
<span class="sd">        elpres : number</span>
<span class="sd">            Parcel EL (equilibrium level) pressure (mb)</span>
<span class="sd">        elhght : number</span>
<span class="sd">            Parcel EL height (m AGL)</span>
<span class="sd">        mplpres : number</span>
<span class="sd">            Maximum Parcel Level (mb)</span>
<span class="sd">        mplhght : number</span>
<span class="sd">            Maximum Parcel Level (m AGL)</span>
<span class="sd">        bplus : number</span>
<span class="sd">            Parcel CAPE (J/kg)</span>
<span class="sd">        bminus : number</span>
<span class="sd">            Parcel CIN below 500 mb (J/kg)</span>
<span class="sd">        bfzl : number</span>
<span class="sd">            Parcel CAPE up to freezing level (J/kg)</span>
<span class="sd">        b3km : number</span>
<span class="sd">            Parcel CAPE up to 3 km (J/kg)</span>
<span class="sd">        b6km : number</span>
<span class="sd">            Parcel CAPE up to 6 km (J/kg)</span>
<span class="sd">        p0c: number</span>
<span class="sd">            Pressure value at 0 C  (mb)</span>
<span class="sd">        pm10c : number</span>
<span class="sd">            Pressure value at -10 C (mb)</span>
<span class="sd">        pm20c : number</span>
<span class="sd">            Pressure value at -20 C (mb)</span>
<span class="sd">        pm30c : number</span>
<span class="sd">            Pressure value at -30 C (mb)</span>
<span class="sd">        hght0c : number</span>
<span class="sd">            Height value at 0 C (m AGL)</span>
<span class="sd">        hghtm10c : number</span>
<span class="sd">            Height value at -10 C (m AGL)</span>
<span class="sd">        hghtm20c : number</span>
<span class="sd">            Height value at -20 C (m AGL)</span>
<span class="sd">        hghtm30c : number</span>
<span class="sd">            Height value at -30 C (m AGL)</span>
<span class="sd">        wm10c : number</span>
<span class="sd">            Wetbulb at -10 C (C)</span>
<span class="sd">        wm20c : number</span>
<span class="sd">            Wetbulb at -20 C (C)</span>
<span class="sd">        wm30c : number</span>
<span class="sd">            Wetbulb at -30 C (C)</span>
<span class="sd">        li5 : number</span>
<span class="sd">            500-mb lifted index (C)</span>
<span class="sd">        li3 : number</span>
<span class="sd">            300-mb lifted index (C)</span>
<span class="sd">        brnshear : number</span>
<span class="sd">            Bulk Richardson Number Shear (kts)</span>
<span class="sd">        brnu : number</span>
<span class="sd">             U-component Bulk Richardson Number Shear (kts)</span>
<span class="sd">        brnv : number</span>
<span class="sd">             V-component Bulk Richardson Number Shear (kts)</span>
<span class="sd">        brn : number</span>
<span class="sd">            Bulk Richardson Number (unitless)</span>
<span class="sd">        limax : number</span>
<span class="sd">            Maximum lifted index value (C)</span>
<span class="sd">        limaxpres : number</span>
<span class="sd">            Pressure at Maximum lifted index (mb)</span>
<span class="sd">        cap : number</span>
<span class="sd">            Cap strength (C)</span>
<span class="sd">        cappres : number</span>
<span class="sd">            Cap strength pressure (mb)</span>
<span class="sd">        bmin : number</span>
<span class="sd">            Buoyancy minimum (C)</span>
<span class="sd">        bminpres : number</span>
<span class="sd">            Pressure at the buoyancy minimum (mb)</span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pres</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel beginning pressure (mb)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpc</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel beginning temperature (C)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwpc</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel beginning dewpoint (C)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ptrace</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel trace pressure (mb)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttrace</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel trace temperature (C)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blayer</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Pressure of the bottom of the layer the parcel is lifted (mb)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlayer</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Pressure of the top of the layer the parcel is lifted (mb)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entrain</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c1"># A parcel entrainment setting (not yet implemented)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lclpres</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel LCL (lifted condensation level) pressure (mb)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lclhght</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel LCL height (m AGL)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lfcpres</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel LFC (level of free convection) pressure (mb)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lfchght</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel LFC height (m AGL)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elpres</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel EL (equilibrium level) pressure (mb)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elhght</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel EL height (m AGL)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mplpres</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Maximum Parcel Level (mb)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mplhght</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Maximum Parcel Level (m AGL)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bplus</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel CAPE (J/kg)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel CIN (J/kg)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bfzl</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel CAPE up to freezing level (J/kg)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b3km</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel CAPE up to 3 km (J/kg)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b6km</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Parcel CAPE up to 6 km (J/kg)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p0c</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Pressure value at 0 C  (mb)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm10c</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Pressure value at -10 C (mb)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm20c</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Pressure value at -20 C (mb)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm30c</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Pressure value at -30 C (mb)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hght0c</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Height value at 0 C (m AGL)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hghtm10c</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Height value at -10 C (m AGL)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hghtm20c</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Height value at -20 C (m AGL)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hghtm30c</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Height value at -30 C (m AGL)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wm10c</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># w velocity at -10 C ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wm20c</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># w velocity at -20 C ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wm30c</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Wet bulb at -30 C ? </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">li5</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Lifted Index at 500 mb (C)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">li3</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Lifted Index at 300 mb (C)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brnshear</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Bulk Richardson Number Shear</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brnu</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Bulk Richardson Number U (kts)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brnv</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Bulk Richardson Number V (kts)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brn</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Bulk Richardson Number (unitless)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limax</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Maximum Lifted Index (C)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limaxpres</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Pressure at Maximum Lifted Index (mb)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cap</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Cap Strength (C)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cappres</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Cap strength pressure (mb)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bmin</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Buoyancy minimum in profile (C)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bminpres</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="c1"># Buoyancy minimum pressure (mb)</span>
        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kw</span><span class="p">))</span></div>

<div class="viewcode-block" id="hgz"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.hgz">[docs]</a><span class="k">def</span> <span class="nf">hgz</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Hail Growth Zone Levels</span>
<span class="sd">    </span>
<span class="sd">        This function finds the pressure levels for the dendritic </span>
<span class="sd">        growth zone (from -10 C to -30 C).  If either temperature cannot be found,</span>
<span class="sd">        it is set to be the surface pressure.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pbot : number</span>
<span class="sd">            Pressure of the bottom level (mb)</span>
<span class="sd">        ptop : number </span>
<span class="sd">            Pressure of the top level (mb)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">pbot</span> <span class="o">=</span> <span class="n">temp_lvl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ptop</span> <span class="o">=</span> <span class="n">temp_lvl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pbot</span><span class="p">):</span>
        <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">ptop</span><span class="p">):</span>
        <span class="n">ptop</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span></div>


<div class="viewcode-block" id="dgz"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.dgz">[docs]</a><span class="k">def</span> <span class="nf">dgz</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Dendritic Growth Zone Levels</span>
<span class="sd">    </span>
<span class="sd">        This function finds the pressure levels for the dendritic </span>
<span class="sd">        growth zone (from -12 C to -17 C).  If either temperature cannot be found,</span>
<span class="sd">        it is set to be the surface pressure.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pbot : number</span>
<span class="sd">            Pressure of the bottom level (mb)</span>
<span class="sd">        ptop : number</span>
<span class="sd">            Pressure of the top level (mb)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">pbot</span> <span class="o">=</span> <span class="n">temp_lvl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ptop</span> <span class="o">=</span> <span class="n">temp_lvl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">-</span><span class="mi">17</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pbot</span><span class="p">):</span>
        <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">ptop</span><span class="p">):</span>
        <span class="n">ptop</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span></div>

<div class="viewcode-block" id="lhp"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.lhp">[docs]</a><span class="k">def</span> <span class="nf">lhp</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Large Hail Parameter</span>

<span class="sd">        From Johnson and Sugden (2014), EJSSM</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This code has not been compared directly against an SPC version.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            ConvectiveProfile object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lhp : number</span>
<span class="sd">            large hail parameter (unitless)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">mag06_shr</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">KTS2MS</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">mag</span><span class="p">(</span><span class="o">*</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc_6km_shear</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">mupcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">&gt;=</span> <span class="mi">400</span> <span class="ow">and</span> <span class="n">mag06_shr</span> <span class="o">&gt;=</span> <span class="mi">14</span><span class="p">:</span>
        <span class="n">lr75</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">lapserate_700_500</span>
        <span class="n">zbot</span><span class="p">,</span> <span class="n">ztop</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">hgz</span><span class="p">(</span><span class="n">prof</span><span class="p">))</span>
        <span class="n">thk_hgz</span> <span class="o">=</span> <span class="n">ztop</span> <span class="o">-</span> <span class="n">zbot</span>

        <span class="n">term_a</span> <span class="o">=</span> <span class="p">(((</span><span class="n">prof</span><span class="o">.</span><span class="n">mupcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">-</span> <span class="mf">2000.</span><span class="p">)</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span> <span class="o">+</span>\
                 <span class="p">((</span><span class="mi">3200</span> <span class="o">-</span> <span class="n">thk_hgz</span><span class="p">)</span><span class="o">/</span><span class="mf">500.</span><span class="p">)</span> <span class="o">+</span>\
                 <span class="p">((</span><span class="n">lr75</span> <span class="o">-</span> <span class="mf">6.5</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">term_a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">term_a</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">p_1km</span><span class="p">,</span> <span class="n">p_3km</span><span class="p">,</span> <span class="n">p_6km</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">6000</span><span class="p">]))</span>
        <span class="n">shear_el</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">KTS2MS</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">mag</span><span class="p">(</span><span class="o">*</span><span class="n">winds</span><span class="o">.</span><span class="n">wind_shear</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">],</span> <span class="n">ptop</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">mupcl</span><span class="o">.</span><span class="n">elpres</span><span class="p">)))</span>
        <span class="n">grw_el_dir</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">mupcl</span><span class="o">.</span><span class="n">elpres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">grw_36_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">comp2vec</span><span class="p">(</span><span class="o">*</span><span class="n">winds</span><span class="o">.</span><span class="n">mean_wind</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">p_3km</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">p_6km</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">grw_alpha_el</span> <span class="o">=</span> <span class="n">grw_el_dir</span> <span class="o">-</span> <span class="n">grw_36_dir</span>

        <span class="k">if</span> <span class="n">grw_alpha_el</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
            <span class="n">grw_alpha_el</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>

        <span class="n">srw_01_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">comp2vec</span><span class="p">(</span><span class="o">*</span><span class="n">winds</span><span class="o">.</span><span class="n">sr_wind</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">],</span> <span class="n">ptop</span><span class="o">=</span><span class="n">p_1km</span><span class="p">,</span> <span class="n">stu</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">srwind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stv</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">srwind</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">srw_36_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">comp2vec</span><span class="p">(</span><span class="o">*</span><span class="n">winds</span><span class="o">.</span><span class="n">sr_wind</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">p_3km</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">p_6km</span><span class="p">,</span> <span class="n">stu</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">srwind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stv</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">srwind</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">srw_alpha_mid</span> <span class="o">=</span> <span class="n">srw_36_dir</span> <span class="o">-</span> <span class="n">srw_01_dir</span>

        <span class="n">term_b</span> <span class="o">=</span> <span class="p">(((</span><span class="n">shear_el</span> <span class="o">-</span> <span class="mf">25.</span><span class="p">)</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span> <span class="o">+</span>\
                  <span class="p">((</span><span class="n">grw_alpha_el</span> <span class="o">+</span> <span class="mf">5.</span><span class="p">)</span><span class="o">/</span><span class="mf">20.</span><span class="p">)</span> <span class="o">+</span>\
                  <span class="p">((</span><span class="n">srw_alpha_mid</span> <span class="o">-</span> <span class="mf">80.</span><span class="p">)</span><span class="o">/</span><span class="mf">10.</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">term_b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">term_b</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">lhp</span> <span class="o">=</span> <span class="n">term_a</span> <span class="o">*</span> <span class="n">term_b</span> <span class="o">+</span> <span class="mi">5</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">lhp</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">lhp</span></div>


<div class="viewcode-block" id="ship"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.ship">[docs]</a><span class="k">def</span> <span class="nf">ship</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the Sig Hail Parameter (SHIP)</span>

<span class="sd">        Ryan Jewell (SPC) helped in correcting this equation as the SPC</span>
<span class="sd">        sounding help page version did not have the correct information</span>
<span class="sd">        of how SHIP was calculated.</span>

<span class="sd">        The significant hail parameter (SHIP; SPC 2014) is</span>
<span class="sd">        an index developed in-house at the SPC. (Johnson and Sugden 2014)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        mupcl : parcel object, optional</span>
<span class="sd">            Most Unstable Parcel object</span>
<span class="sd">        lr75 : float, optional</span>
<span class="sd">            700 - 500 mb lapse rate (C/km)</span>
<span class="sd">        h5_temp : float, optional</span>
<span class="sd">            500 mb temperature (C)</span>
<span class="sd">        shr06 : float, optional</span>
<span class="sd">            0-6 km shear (m/s)</span>
<span class="sd">        frz_lvl : float, optional</span>
<span class="sd">            freezing level (m)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ship : number</span>
<span class="sd">            significant hail parameter (unitless)</span>

<span class="sd">    &#39;&#39;&#39;</span>
      
    <span class="n">mupcl</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mupcl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">sfc6shr</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sfc6shr&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">frz_lvl</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;frz_lvl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">h5_temp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;h5_temp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">lr75</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lr75&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mupcl</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mupcl</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">mupcl</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">mulplvals</span> <span class="o">=</span> <span class="n">DefineParcel</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="n">mupcl</span> <span class="o">=</span> <span class="n">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">lplvals</span><span class="o">=</span><span class="n">mulplvals</span><span class="p">)</span>
    <span class="n">mucape</span> <span class="o">=</span> <span class="n">mupcl</span><span class="o">.</span><span class="n">bplus</span>
    <span class="n">mumr</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">mixratio</span><span class="p">(</span><span class="n">mupcl</span><span class="o">.</span><span class="n">pres</span><span class="p">,</span> <span class="n">mupcl</span><span class="o">.</span><span class="n">dwpc</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">frz_lvl</span><span class="p">:</span>
        <span class="n">frz_lvl</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">temp_lvl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">h5_temp</span><span class="p">:</span>
        <span class="n">h5_temp</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">500.</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">lr75</span><span class="p">:</span>
        <span class="n">lr75</span> <span class="o">=</span> <span class="n">lapse_rate</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">700.</span><span class="p">,</span> <span class="mf">500.</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">sfc6shr</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sfc_6km_shear</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">sfc_6km_shear</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sfc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
            <span class="n">p6km</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">6000.</span><span class="p">))</span>
            <span class="n">sfc_6km_shear</span> <span class="o">=</span> <span class="n">winds</span><span class="o">.</span><span class="n">wind_shear</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">sfc</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">p6km</span><span class="p">)</span>
    
    <span class="n">sfc_6km_shear</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mag</span><span class="p">(</span><span class="n">sfc_6km_shear</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sfc_6km_shear</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">shr06</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">KTS2MS</span><span class="p">(</span><span class="n">sfc_6km_shear</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">shr06</span> <span class="o">&gt;</span> <span class="mi">27</span><span class="p">:</span>
        <span class="n">shr06</span> <span class="o">=</span> <span class="mf">27.</span>
    <span class="k">elif</span> <span class="n">shr06</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">shr06</span> <span class="o">=</span> <span class="mf">7.</span>

    <span class="k">if</span> <span class="n">mumr</span> <span class="o">&gt;</span> <span class="mf">13.6</span><span class="p">:</span>
        <span class="n">mumr</span> <span class="o">=</span> <span class="mf">13.6</span>
    <span class="k">elif</span> <span class="n">mumr</span> <span class="o">&lt;</span> <span class="mf">11.</span><span class="p">:</span>
        <span class="n">mumr</span> <span class="o">=</span> <span class="mf">11.</span>

    <span class="k">if</span> <span class="n">h5_temp</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">5.5</span><span class="p">:</span>
        <span class="n">h5_temp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.5</span>

    <span class="n">ship</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="p">(</span><span class="n">mucape</span> <span class="o">*</span> <span class="n">mumr</span> <span class="o">*</span> <span class="n">lr75</span> <span class="o">*</span> <span class="n">h5_temp</span> <span class="o">*</span> <span class="n">shr06</span><span class="p">)</span> <span class="o">/</span> <span class="mf">42000000.</span>
    
    <span class="k">if</span> <span class="n">mucape</span> <span class="o">&lt;</span> <span class="mi">1300</span><span class="p">:</span>
        <span class="n">ship</span> <span class="o">=</span> <span class="n">ship</span><span class="o">*</span><span class="p">(</span><span class="n">mucape</span><span class="o">/</span><span class="mf">1300.</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">lr75</span> <span class="o">&lt;</span> <span class="mf">5.8</span><span class="p">:</span>
        <span class="n">ship</span> <span class="o">=</span> <span class="n">ship</span><span class="o">*</span><span class="p">(</span><span class="n">lr75</span><span class="o">/</span><span class="mf">5.8</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frz_lvl</span> <span class="o">&lt;</span> <span class="mi">2400</span><span class="p">:</span>
        <span class="n">ship</span> <span class="o">=</span> <span class="n">ship</span> <span class="o">*</span> <span class="p">(</span><span class="n">frz_lvl</span><span class="o">/</span><span class="mf">2400.</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ship</span></div>

<div class="viewcode-block" id="stp_cin"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.stp_cin">[docs]</a><span class="k">def</span> <span class="nf">stp_cin</span><span class="p">(</span><span class="n">mlcape</span><span class="p">,</span> <span class="n">esrh</span><span class="p">,</span> <span class="n">ebwd</span><span class="p">,</span> <span class="n">mllcl</span><span class="p">,</span> <span class="n">mlcinh</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Significant Tornado Parameter (w/CIN)</span>

<span class="sd">        Formulated using the methodology outlined in [1]_.  Used to detect environments where significant tornadoes</span>
<span class="sd">        are possible within the United States.  Uses the effective inflow layer calculations in [3]_ and was created</span>
<span class="sd">        as an alternative to [2]_.</span>

<span class="sd">        .. [1] Thompson, R. L., B. T. Smith, J. S. Grams, A. R. Dean, and C. Broyles, 2012: Convective modes for significant severe thunderstorms in the contiguous United States.Part II: Supercell and QLCS tornado environments. Wea. Forecasting, 27, 11361154,doi:https://doi.org/10.1175/WAF-D-11-00116.1.</span>
<span class="sd">        .. [3] Thompson, R. L., C. M. Mead, and R. Edwards, 2007: Effective storm-relative helicity and bulk shear in supercell thunderstorm environments. Wea. Forecasting, 22, 102115, doi:https://doi.org/10.1175/WAF969.1.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mlcape : float</span>
<span class="sd">            Mixed-layer CAPE from the parcel class (J/kg)</span>
<span class="sd">        esrh : float</span>
<span class="sd">            effective storm relative helicity (m2/s2)</span>
<span class="sd">        ebwd : float</span>
<span class="sd">            effective bulk wind difference (m/s)</span>
<span class="sd">        mllcl : float</span>
<span class="sd">            mixed-layer lifted condensation level (m)</span>
<span class="sd">        mlcinh : float</span>
<span class="sd">            mixed-layer convective inhibition (J/kg)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        stp_cin : number</span>
<span class="sd">            significant tornado parameter (unitless)</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        stp_fixed</span>


<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">cape_term</span> <span class="o">=</span> <span class="n">mlcape</span> <span class="o">/</span> <span class="mf">1500.</span>
    <span class="n">eshr_term</span> <span class="o">=</span> <span class="n">esrh</span> <span class="o">/</span> <span class="mf">150.</span>
    
    <span class="k">if</span> <span class="n">ebwd</span> <span class="o">&lt;</span> <span class="mf">12.5</span><span class="p">:</span>
        <span class="n">ebwd_term</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">elif</span> <span class="n">ebwd</span> <span class="o">&gt;</span> <span class="mf">30.</span><span class="p">:</span>
        <span class="n">ebwd_term</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ebwd_term</span>  <span class="o">=</span> <span class="n">ebwd</span> <span class="o">/</span> <span class="mf">20.</span>

    <span class="k">if</span> <span class="n">mllcl</span> <span class="o">&lt;</span> <span class="mf">1000.</span><span class="p">:</span>
        <span class="n">lcl_term</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="n">mllcl</span> <span class="o">&gt;</span> <span class="mf">2000.</span><span class="p">:</span>
        <span class="n">lcl_term</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lcl_term</span> <span class="o">=</span> <span class="p">((</span><span class="mf">2000.</span> <span class="o">-</span> <span class="n">mllcl</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mlcinh</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">50</span><span class="p">:</span>
        <span class="n">cinh_term</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="n">mlcinh</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">200</span><span class="p">:</span>
        <span class="n">cinh_term</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cinh_term</span> <span class="o">=</span> <span class="p">((</span><span class="n">mlcinh</span> <span class="o">+</span> <span class="mf">200.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">150.</span><span class="p">)</span>

    <span class="n">stp_cin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">cape_term</span> <span class="o">*</span> <span class="n">eshr_term</span> <span class="o">*</span> <span class="n">ebwd_term</span> <span class="o">*</span> <span class="n">lcl_term</span> <span class="o">*</span> <span class="n">cinh_term</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stp_cin</span></div>



<div class="viewcode-block" id="stp_fixed"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.stp_fixed">[docs]</a><span class="k">def</span> <span class="nf">stp_fixed</span><span class="p">(</span><span class="n">sbcape</span><span class="p">,</span> <span class="n">sblcl</span><span class="p">,</span> <span class="n">srh01</span><span class="p">,</span> <span class="n">bwd6</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Significant Tornado Parameter (fixed layer)</span>
<span class="sd">   </span>
<span class="sd">        Formulated using the methodology in [2]_.  Used to detect environments where significant tornadoes</span>
<span class="sd">        are possible within the United States.</span>

<span class="sd">        .. [2] Thompson, R. L., R. Edwards, J. A. Hart, K. L. Elmore, and P. Markowski, 2003: Close proximity soundings within supercell environments obtained from the Rapid Update Cycle. Wea. Forecasting, 18, 12431261, doi:https://doi.org/10.1175/1520-0434(2003)018&lt;1243:CPSWSE&gt;2.0.CO;2</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sbcape : number</span>
<span class="sd">            Surface based CAPE from the parcel class (J/kg)</span>
<span class="sd">        sblcl : number</span>
<span class="sd">            Surface based lifted condensation level (LCL) (m)</span>
<span class="sd">        srh01 : number</span>
<span class="sd">            Surface to 1 km storm relative helicity (m2/s2)</span>
<span class="sd">        bwd6 : number</span>
<span class="sd">            Bulk wind difference between 0 to 6 km (m/s)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        stp_fixed : number</span>
<span class="sd">            signifcant tornado parameter (fixed-layer)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># Calculate SBLCL term</span>
    <span class="k">if</span> <span class="n">sblcl</span> <span class="o">&lt;</span> <span class="mf">1000.</span><span class="p">:</span> <span class="c1"># less than 1000. meters</span>
        <span class="n">lcl_term</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="n">sblcl</span> <span class="o">&gt;</span> <span class="mf">2000.</span><span class="p">:</span> <span class="c1"># greater than 2000. meters</span>
        <span class="n">lcl_term</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lcl_term</span> <span class="o">=</span> <span class="p">((</span><span class="mf">2000.</span><span class="o">-</span><span class="n">sblcl</span><span class="p">)</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span>

    <span class="c1"># Calculate 6BWD term</span>
    <span class="k">if</span> <span class="n">bwd6</span> <span class="o">&gt;</span> <span class="mf">30.</span><span class="p">:</span> <span class="c1"># greater than 30 m/s</span>
        <span class="n">bwd6</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="k">elif</span> <span class="n">bwd6</span> <span class="o">&lt;</span> <span class="mf">12.5</span><span class="p">:</span>
        <span class="n">bwd6</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="n">bwd6_term</span> <span class="o">=</span> <span class="n">bwd6</span> <span class="o">/</span> <span class="mf">20.</span>

    <span class="n">cape_term</span> <span class="o">=</span> <span class="n">sbcape</span> <span class="o">/</span> <span class="mf">1500.</span>
    <span class="n">srh_term</span> <span class="o">=</span> <span class="n">srh01</span> <span class="o">/</span> <span class="mf">150.</span>

    <span class="n">stp_fixed</span> <span class="o">=</span> <span class="n">cape_term</span> <span class="o">*</span> <span class="n">lcl_term</span> <span class="o">*</span> <span class="n">srh_term</span> <span class="o">*</span> <span class="n">bwd6_term</span>
   
    <span class="k">return</span> <span class="n">stp_fixed</span></div>



<div class="viewcode-block" id="scp"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.scp">[docs]</a><span class="k">def</span> <span class="nf">scp</span><span class="p">(</span><span class="n">mucape</span><span class="p">,</span> <span class="n">srh</span><span class="p">,</span> <span class="n">ebwd</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Supercell Composite Parameter</span>

<span class="sd">        From Thompson et al. 2004, updated from the methodology in [2]_ and uses</span>
<span class="sd">        the effective inflow layer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        mucape : number, optional</span>
<span class="sd">            Most Unstable CAPE from the parcel class (J/kg) (optional)</span>
<span class="sd">        srh : number, optional</span>
<span class="sd">            the effective SRH from the winds.helicity function (m2/s2)</span>
<span class="sd">        ebwd : number, optional</span>
<span class="sd">            effective bulk wind difference (m/s)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        scp : number</span>
<span class="sd">            supercell composite parameter</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">ebwd</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="n">ebwd</span> <span class="o">=</span> <span class="mf">20.</span>
    <span class="k">elif</span> <span class="n">ebwd</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">ebwd</span> <span class="o">=</span> <span class="mf">0.</span>
     
    <span class="n">muCAPE_term</span> <span class="o">=</span> <span class="n">mucape</span> <span class="o">/</span> <span class="mf">1000.</span>
    <span class="n">esrh_term</span> <span class="o">=</span> <span class="n">srh</span> <span class="o">/</span> <span class="mf">50.</span>
    <span class="n">ebwd_term</span> <span class="o">=</span> <span class="n">ebwd</span> <span class="o">/</span> <span class="mf">20.</span>

    <span class="n">scp</span> <span class="o">=</span> <span class="n">muCAPE_term</span> <span class="o">*</span> <span class="n">esrh_term</span> <span class="o">*</span> <span class="n">ebwd_term</span>
    <span class="k">return</span> <span class="n">scp</span></div>

<div class="viewcode-block" id="k_index"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.k_index">[docs]</a><span class="k">def</span> <span class="nf">k_index</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the K-Index from a profile object</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        k_index : number</span>
<span class="sd">            K-Index</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="n">t8</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">850.</span><span class="p">)</span>
    <span class="n">t7</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">700.</span><span class="p">)</span>
    <span class="n">t5</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">500.</span><span class="p">)</span>
    <span class="n">td7</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">700.</span><span class="p">)</span>
    <span class="n">td8</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">850.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t8</span> <span class="o">-</span> <span class="n">t5</span> <span class="o">+</span> <span class="n">td8</span> <span class="o">-</span> <span class="p">(</span><span class="n">t7</span> <span class="o">-</span> <span class="n">td7</span><span class="p">)</span></div>


<div class="viewcode-block" id="t_totals"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.t_totals">[docs]</a><span class="k">def</span> <span class="nf">t_totals</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the Total Totals Index from a profile object</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        t_totals : number</span>
<span class="sd">            Total Totals Index</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">c_totals</span><span class="p">(</span><span class="n">prof</span><span class="p">)</span> <span class="o">+</span> <span class="n">v_totals</span><span class="p">(</span><span class="n">prof</span><span class="p">)</span></div>


<div class="viewcode-block" id="c_totals"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.c_totals">[docs]</a><span class="k">def</span> <span class="nf">c_totals</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the Cross Totals Index from a profile object</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        c_totals : number</span>
<span class="sd">            Cross Totals Index</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">850.</span><span class="p">)</span> <span class="o">-</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">500.</span><span class="p">)</span></div>


<div class="viewcode-block" id="v_totals"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.v_totals">[docs]</a><span class="k">def</span> <span class="nf">v_totals</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the Vertical Totals Index from a profile object</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        v_totals : number</span>
<span class="sd">            Vertical Totals Index</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">850.</span><span class="p">)</span> <span class="o">-</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">500.</span><span class="p">)</span></div>


<div class="viewcode-block" id="precip_water"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.precip_water">[docs]</a><span class="k">def</span> <span class="nf">precip_water</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">dp</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the precipitable water from a profile object within the</span>
<span class="sd">        specified layer. The default layer (lower=-1 &amp; upper=-1) is defined to</span>
<span class="sd">        be surface to 400 hPa.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        pbot : number (optional; default surface)</span>
<span class="sd">            Pressure of the bottom level (hPa)</span>
<span class="sd">        ptop : number (optional; default 400 hPa)</span>
<span class="sd">            Pressure of the top level (hPa).</span>
<span class="sd">        dp : negative integer (optional; default = -1)</span>
<span class="sd">            The pressure increment for the interpolated sounding</span>
<span class="sd">        exact : bool (optional; default = False)</span>
<span class="sd">            Switch to choose between using the exact data (slower) or using</span>
<span class="sd">            interpolated sounding at &#39;dp&#39; pressure levels (faster)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pwat : number,</span>
<span class="sd">            Precipitable Water (in)</span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pbot</span><span class="p">:</span> <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ptop</span><span class="p">:</span>
        <span class="n">ptop</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">exact</span><span class="p">:</span>
        <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pbot</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ptop</span> <span class="o">&lt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">dwpt1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)</span>
        <span class="n">dwpt2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="o">~</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dwpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">dwpt1</span><span class="p">],</span> <span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="p">[</span><span class="n">dwpt2</span><span class="p">]])</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">pbot</span><span class="p">],</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="p">[</span><span class="n">ptop</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="o">+</span><span class="n">dp</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">pbot</span><span class="p">))</span>
        <span class="n">dwpt</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">mixratio</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">dwpt</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(((</span><span class="n">w</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span> <span class="o">*</span> <span class="mf">0.00040173</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">inferred_temp_adv</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">dp</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="mi">35</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Inferred Temperature Advection</span>

<span class="sd">        SHARP code deduced by Greg Blumberg.  Not based on actual SPC code.</span>

<span class="sd">        Calculates the inferred temperature advection from the surface pressure</span>
<span class="sd">        and up every 100 mb assuming all winds are geostrophic.  The units returned are</span>
<span class="sd">        in C/hr.  If no latitude is specified the function defaults to 35 degrees North.</span>

<span class="sd">        This code uses Equation 4.1.139 from Bluestein&#39;s &quot;Synoptic-Dynamic Meteorology in Midlatitudes (Volume I)&quot;</span>

<span class="sd">        .. important::</span>
<span class="sd">            While this code compares well qualitatively to the version at SPC, the SPC output is much larger.  Scale</span>
<span class="sd">            analysis suggests that the values provided by this function are much more reasonable (10 K/day is typical</span>
<span class="sd">            for synoptic scale values).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        dp : number, optional</span>
<span class="sd">            layer size to compute temperature advection over</span>
<span class="sd">        lat : number, optional</span>
<span class="sd">            latitude in decimal degrees</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        temp_adv : array</span>
<span class="sd">            an array of temperature advection values (C/hr)</span>
<span class="sd">        pressure_bounds: array</span>
<span class="sd">            a 2D array indicating the top and bottom bounds of the temperature advection layers (mb)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">wdir</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">,</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">,</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>

    <span class="n">omega</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">86164.</span><span class="p">)</span>
       
    <span class="n">pres_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span> <span class="o">&gt;=</span> <span class="mf">100.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pressures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">get_sfc</span><span class="p">()],</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">pres_idx</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">get_sfc</span><span class="p">()]))</span> <span class="c1"># Units: mb</span>
    <span class="n">temps</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pressures</span><span class="p">))</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pressures</span><span class="p">)</span>
    <span class="n">temp_adv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pressures</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pressures</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pressure_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pressures</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">lat</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">omega</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span> <span class="c1"># Units: (s**-1)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">temp_adv</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">temp_adv</span><span class="p">,</span> <span class="n">pressure_bounds</span>

    <span class="n">multiplier</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">/</span> <span class="mf">9.81</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span> <span class="c1"># Units: (s**-1 / (m/s**2)) * (radians/degrees)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pressures</span><span class="p">)):</span>
        <span class="n">bottom_pres</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">top_pres</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># Get the temperatures from both levels (in Kelvin)</span>
        <span class="n">btemp</span> <span class="o">=</span> <span class="n">temps</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ttemp</span> <span class="o">=</span> <span class="n">temps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># Get the two heights of the top and bottom layer</span>
        <span class="n">bhght</span> <span class="o">=</span> <span class="n">heights</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Units: meters</span>
        <span class="n">thght</span> <span class="o">=</span> <span class="n">heights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># Units: meters</span>
        <span class="n">bottom_wdir</span> <span class="o">=</span> <span class="n">dirs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Meteorological degrees (degrees from north)</span>
        <span class="n">top_wdir</span> <span class="o">=</span> <span class="n">dirs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># same units as top_wdir</span>
        
        <span class="c1"># Calculate the average temperature</span>
        <span class="n">avg_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ttemp</span> <span class="o">+</span> <span class="n">btemp</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.</span>
        
        <span class="c1"># Calculate the mean wind between the two levels (this is assumed to be geostrophic)</span>
        <span class="n">mean_u</span><span class="p">,</span> <span class="n">mean_v</span> <span class="o">=</span> <span class="n">winds</span><span class="o">.</span><span class="n">mean_wind</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">bottom_pres</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">top_pres</span><span class="p">)</span>
        <span class="n">mean_wdir</span><span class="p">,</span> <span class="n">mean_wspd</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">comp2vec</span><span class="p">(</span><span class="n">mean_u</span><span class="p">,</span> <span class="n">mean_v</span><span class="p">)</span> <span class="c1"># Wind speed is in knots here</span>
        <span class="n">mean_wspd</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">KTS2MS</span><span class="p">(</span><span class="n">mean_wspd</span><span class="p">)</span> <span class="c1"># Convert this geostrophic wind speed to m/s</span>
        
        <span class="c1"># Here we calculate the change in wind direction with height (thanks to Andrew Mackenzie for help with this)</span>
        <span class="c1"># The sign of d_theta will dictate whether or not it is warm or cold advection</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="mi">180</span> <span class="o">-</span> <span class="n">bottom_wdir</span>
        <span class="n">top_wdir</span> <span class="o">=</span> <span class="n">top_wdir</span> <span class="o">+</span> <span class="n">mod</span>
        
        <span class="k">if</span> <span class="n">top_wdir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">top_wdir</span> <span class="o">=</span> <span class="n">top_wdir</span> <span class="o">+</span> <span class="mi">360</span>
        <span class="k">elif</span> <span class="n">top_wdir</span> <span class="o">&gt;=</span> <span class="mi">360</span><span class="p">:</span>
            <span class="n">top_wdir</span> <span class="o">=</span> <span class="n">top_wdir</span> <span class="o">-</span> <span class="mi">360</span>
        <span class="n">d_theta</span> <span class="o">=</span> <span class="n">top_wdir</span> <span class="o">-</span> <span class="mf">180.</span>
        
        <span class="c1"># Here we calculate t_adv (which is -V_g * del(T) or the local change in temperature term)</span>
        <span class="c1"># K/s  s * rad/m * deg   m^2/s^2          K        degrees / m</span>
        <span class="n">t_adv</span> <span class="o">=</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">mean_wspd</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">avg_temp</span> <span class="o">*</span> <span class="p">(</span><span class="n">d_theta</span> <span class="o">/</span> <span class="p">(</span><span class="n">thght</span> <span class="o">-</span> <span class="n">bhght</span><span class="p">))</span> <span class="c1"># Units: Kelvin / seconds</span>
        
        <span class="c1"># Append the pressure bounds so the person knows the pressure</span>
        <span class="n">pressure_bounds</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">bottom_pres</span><span class="p">,</span> <span class="n">top_pres</span>
        <span class="n">temp_adv</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_adv</span><span class="o">*</span><span class="mf">60.</span><span class="o">*</span><span class="mf">60.</span> <span class="c1"># Converts Kelvin/seconds to Kelvin/hour (or Celsius/hour)</span>

    <span class="k">return</span> <span class="n">temp_adv</span><span class="p">,</span> <span class="n">pressure_bounds</span>


<div class="viewcode-block" id="temp_lvl"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.temp_lvl">[docs]</a><span class="k">def</span> <span class="nf">temp_lvl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">wetbulb</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the level (hPa) of the first occurrence of the specified</span>
<span class="sd">        temperature.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        temp : number</span>
<span class="sd">            Temperature being searched (C)</span>
<span class="sd">        wetbulb : boolean</span>
<span class="sd">            Flag to indicate whether or not the wetbulb profile should be used instead</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        First Level of the temperature (hPa) : number</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">wetbulb</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">wetbulb</span>

    <span class="n">difft</span> <span class="o">=</span> <span class="n">profile</span> <span class="o">-</span> <span class="n">temp</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">difft</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">difft</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># Temp doesn&#39;t occur anywhere; return masked</span>
        <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">difft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># Temp is one of the data points; don&#39;t bother interpolating</span>
        <span class="k">return</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">difft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">difft</span><span class="o">.</span><span class="n">mask</span> <span class="o">|</span> <span class="n">prof</span><span class="o">.</span><span class="n">logp</span><span class="o">.</span><span class="n">mask</span>

    <span class="n">difft</span> <span class="o">=</span> <span class="n">difft</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">logp</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">logp</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>

    <span class="c1"># Find where subsequent values of difft are of opposite sign (i.e. when multiplied together, the result is negative)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">difft</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">difft</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="p">[</span><span class="n">profile</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">profile</span><span class="p">[</span><span class="n">ind</span><span class="p">]],</span>
                            <span class="p">[</span><span class="n">logp</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">logp</span><span class="p">[</span><span class="n">ind</span><span class="p">]]))</span></div>


<div class="viewcode-block" id="max_temp"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.max_temp">[docs]</a><span class="k">def</span> <span class="nf">max_temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">mixlayer</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates a maximum temperature forecast based on the depth of the mixing</span>
<span class="sd">        layer and low-level temperatures</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        mixlayer : number (optional; default = 100)</span>
<span class="sd">            Top of layer over which to &quot;mix&quot; (hPa)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mtemp : number</span>
<span class="sd">            Forecast Maximum Temperature</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="n">mixlayer</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span> <span class="o">-</span> <span class="n">mixlayer</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">mixlayer</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ktoc</span><span class="p">(</span><span class="n">temp</span> <span class="o">*</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span> <span class="o">/</span> <span class="n">mixlayer</span><span class="p">)</span><span class="o">**</span><span class="n">ROCP</span><span class="p">)</span></div>


<div class="viewcode-block" id="mean_relh"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.mean_relh">[docs]</a><span class="k">def</span> <span class="nf">mean_relh</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dp</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the mean relative humidity from a profile object within the</span>
<span class="sd">        specified layer.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        pbot : number (optional; default surface)</span>
<span class="sd">            Pressure of the bottom level (hPa)</span>
<span class="sd">        ptop : number (optional; default 400 hPa)</span>
<span class="sd">            Pressure of the top level (hPa)</span>
<span class="sd">        dp : negative integer (optional; default = -1)</span>
<span class="sd">            The pressure increment for the interpolated sounding (mb)</span>
<span class="sd">        exact : bool (optional; default = False)</span>
<span class="sd">            Switch to choose between using the exact data (slower) or using</span>
<span class="sd">            interpolated sounding at &#39;dp&#39; pressure levels (faster)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Mean Relative Humidity : number</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pbot</span><span class="p">:</span> <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ptop</span><span class="p">:</span> <span class="n">ptop</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span> <span class="o">-</span> <span class="mf">100.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)):</span> <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)):</span> <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">if</span> <span class="n">exact</span><span class="p">:</span>
        <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pbot</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ptop</span> <span class="o">&lt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">dwpt1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)</span>
        <span class="n">dwpt2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="o">~</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dwpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">dwpt1</span><span class="p">],</span> <span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span>
                               <span class="p">[</span><span class="n">dwpt2</span><span class="p">]])</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">pbot</span><span class="p">],</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="p">[</span><span class="n">ptop</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="o">+</span><span class="n">dp</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">pbot</span><span class="p">))</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">dwpt</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">rh</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">relh</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">dwpt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">p</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">mean_omega</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dp</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the mean omega from a profile object within the</span>
<span class="sd">        specified layer.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        pbot : number (optional; default surface)</span>
<span class="sd">            Pressure of the bottom level (hPa)</span>
<span class="sd">        ptop : number (optional; default 400 hPa)</span>
<span class="sd">            Pressure of the top level (hPa)</span>
<span class="sd">        dp : negative integer (optional; default = -1)</span>
<span class="sd">            The pressure increment for the interpolated sounding (mb)</span>
<span class="sd">        exact : bool (optional; default = False)</span>
<span class="sd">            Switch to choose between using the exact data (slower) or using</span>
<span class="sd">            interpolated sounding at &#39;dp&#39; pressure levels (faster)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Mean Omega : number</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;omeg&#39;</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">omeg</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">prof</span><span class="o">.</span><span class="n">missing</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">prof</span><span class="o">.</span><span class="n">missing</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pbot</span><span class="p">:</span> <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ptop</span><span class="p">:</span> <span class="n">ptop</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span> <span class="o">-</span> <span class="mf">100.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">omeg</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)):</span> <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">omeg</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)):</span> <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">if</span> <span class="n">exact</span><span class="p">:</span>
        <span class="c1"># This condition of the if statement is not tested</span>
        <span class="n">omeg</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">omeg</span>
        <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pbot</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ptop</span> <span class="o">&lt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">omeg1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">omeg</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)</span>
        <span class="n">omeg2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">omeg</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)</span>
        <span class="n">omeg</span> <span class="o">=</span> <span class="n">omeg</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">omeg</span><span class="o">.</span><span class="n">mask</span>
        <span class="n">omeg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">omeg1</span><span class="p">],</span> <span class="n">omeg</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">omeg</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="p">[</span><span class="n">omeg2</span><span class="p">]])</span>
        <span class="n">tott</span> <span class="o">=</span> <span class="n">omeg</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">omeg</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">thta</span> <span class="o">=</span> <span class="n">tott</span> <span class="o">/</span> <span class="n">num</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="o">+</span><span class="n">dp</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">pbot</span><span class="p">))</span>
        <span class="n">omeg</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">omeg</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">omeg</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">omeg</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">omeg</span>

<div class="viewcode-block" id="mean_mixratio"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.mean_mixratio">[docs]</a><span class="k">def</span> <span class="nf">mean_mixratio</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dp</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the mean mixing ratio from a profile object within the</span>
<span class="sd">        specified layer.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        pbot : number (optional; default surface)</span>
<span class="sd">            Pressure of the bottom level (hPa)</span>
<span class="sd">        ptop : number (optional; default 400 hPa)</span>
<span class="sd">            Pressure of the top level (hPa)</span>
<span class="sd">        dp : negative integer (optional; default = -1)</span>
<span class="sd">            The pressure increment for the interpolated sounding (mb)</span>
<span class="sd">        exact : bool (optional; default = False)</span>
<span class="sd">            Switch to choose between using the exact data (slower) or using</span>
<span class="sd">            interpolated sounding at &#39;dp&#39; pressure levels (faster)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Mean Mixing Ratio : number</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pbot</span><span class="p">:</span> <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ptop</span><span class="p">:</span> <span class="n">ptop</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span> <span class="o">-</span> <span class="mf">100.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)):</span> <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)):</span> <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">if</span> <span class="n">exact</span><span class="p">:</span>
        <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pbot</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ptop</span> <span class="o">&lt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">dwpt1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)</span>
        <span class="n">dwpt2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="o">~</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dwpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">dwpt1</span><span class="p">],</span> <span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="p">[</span><span class="n">dwpt2</span><span class="p">]])</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">pbot</span><span class="p">],</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="p">[</span><span class="n">ptop</span><span class="p">]])</span>
        <span class="n">totd</span> <span class="o">=</span> <span class="n">dwpt</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">totp</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dwpt</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">mixratio</span><span class="p">(</span><span class="n">totp</span><span class="o">/</span><span class="n">num</span><span class="p">,</span> <span class="n">totd</span><span class="o">/</span><span class="n">num</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="o">+</span><span class="n">dp</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">pbot</span><span class="p">))</span>
        <span class="n">dwpt</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">mixratio</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">dwpt</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">w</span></div>

<div class="viewcode-block" id="mean_thetae"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.mean_thetae">[docs]</a><span class="k">def</span> <span class="nf">mean_thetae</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dp</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the mean theta-e from a profile object within the</span>
<span class="sd">        specified layer.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        pbot : number (optional; default surface)</span>
<span class="sd">            Pressure of the bottom level (hPa)</span>
<span class="sd">        ptop : number (optional; default 400 hPa)</span>
<span class="sd">            Pressure of the top level (hPa)</span>
<span class="sd">        dp : negative integer (optional; default = -1)</span>
<span class="sd">            The pressure increment for the interpolated sounding (mb)</span>
<span class="sd">        exact : bool (optional; default = False)</span>
<span class="sd">            Switch to choose between using the exact data (slower) or using</span>
<span class="sd">            interpolated sounding at &#39;dp&#39; pressure levels (faster)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Mean Theta-E : number</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pbot</span><span class="p">:</span> <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ptop</span><span class="p">:</span> <span class="n">ptop</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span> <span class="o">-</span> <span class="mf">100.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)):</span> <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)):</span> <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">if</span> <span class="n">exact</span><span class="p">:</span>
        <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pbot</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ptop</span> <span class="o">&lt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">thetae1</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">thetae</span><span class="p">(</span><span class="n">pbot</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">),</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">))</span>
        <span class="n">thetae2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">thetae</span><span class="p">(</span><span class="n">ptop</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">),</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">))</span>
        <span class="n">thetae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">thetae</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">thetae</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">thetae</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>  <span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">thetae</span><span class="o">.</span><span class="n">mask</span>
        <span class="n">thetae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">thetae1</span><span class="p">],</span> <span class="n">thetae</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">thetae</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="p">[</span><span class="n">thetae2</span><span class="p">]])</span>
        <span class="n">tott</span> <span class="o">=</span> <span class="n">thetae</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">thetae</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">thtae</span> <span class="o">=</span> <span class="n">tott</span> <span class="o">/</span> <span class="n">num</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="o">+</span><span class="n">dp</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">pbot</span><span class="p">))</span>
        <span class="c1">#temp = interp.temp(prof, p)</span>
        <span class="c1">#dwpt = interp.dwpt(prof, p)</span>
        <span class="c1">#thetae = np.empty(p.shape)</span>
        <span class="c1">#for i in np.arange(0, len(thetae), 1):</span>
        <span class="c1">#   thetae[i] = thermo.thetae(p[i], temp[i], dwpt[i])</span>
        <span class="n">thetae</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">thetae</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">thtae</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">thetae</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thtae</span></div>

<div class="viewcode-block" id="mean_theta"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.mean_theta">[docs]</a><span class="k">def</span> <span class="nf">mean_theta</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dp</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the mean theta from a profile object within the</span>
<span class="sd">        specified layer.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        pbot : number (optional; default surface)</span>
<span class="sd">            Pressure of the bottom level (hPa)</span>
<span class="sd">        ptop : number (optional; default 400 hPa)</span>
<span class="sd">            Pressure of the top level (hPa)</span>
<span class="sd">        dp : negative integer (optional; default = -1)</span>
<span class="sd">            The pressure increment for the interpolated sounding (mb)</span>
<span class="sd">        exact : bool (optional; default = False)</span>
<span class="sd">            Switch to choose between using the exact data (slower) or using</span>
<span class="sd">            interpolated sounding at &#39;dp&#39; pressure levels (faster)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Mean Theta : number</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pbot</span><span class="p">:</span> <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ptop</span><span class="p">:</span> <span class="n">ptop</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span> <span class="o">-</span> <span class="mf">100.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)):</span> <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)):</span> <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">if</span> <span class="n">exact</span><span class="p">:</span>
        <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pbot</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ptop</span> <span class="o">&lt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">theta1</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">pbot</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">))</span>
        <span class="n">theta2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">ptop</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">))</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>  <span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">theta</span><span class="o">.</span><span class="n">mask</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">theta1</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="p">[</span><span class="n">theta2</span><span class="p">]])</span>
        <span class="n">tott</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">thta</span> <span class="o">=</span> <span class="n">tott</span> <span class="o">/</span> <span class="n">num</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="o">+</span><span class="n">dp</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">pbot</span><span class="p">))</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
        <span class="n">thta</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thta</span></div>


<div class="viewcode-block" id="lapse_rate"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.lapse_rate">[docs]</a><span class="k">def</span> <span class="nf">lapse_rate</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the lapse rate (C/km) from a profile object</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        lower : number</span>
<span class="sd">            Lower Bound of lapse rate (mb or m AGL)</span>
<span class="sd">        upper : number</span>
<span class="sd">            Upper Bound of lapse rate (mb or m AGL)</span>
<span class="sd">        pres : bool (optional; default = True)</span>
<span class="sd">            Flag to determine if lower/upper are pressure [True]</span>
<span class="sd">            or height [False]</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lapse rate (C/km) : number</span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">pres</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">):</span> <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span> 
        <span class="n">p1</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">upper</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">z1</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">z2</span><span class="p">)</span>
    <span class="n">tv1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>
    <span class="n">tv2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">tv2</span> <span class="o">-</span> <span class="n">tv1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">z2</span> <span class="o">-</span> <span class="n">z1</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1000.</span></div>

<div class="viewcode-block" id="max_lapse_rate"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.max_lapse_rate">[docs]</a><span class="k">def</span> <span class="nf">max_lapse_rate</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the maximum lapse rate (C/km) between a layer at a specified interval</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof: profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        lower : number</span>
<span class="sd">            Lower bound in height (m)</span>
<span class="sd">        upper : number</span>
<span class="sd">            Upper bound in height (m)</span>
<span class="sd">        interval : number</span>
<span class="sd">            Interval to assess the lapse rate at (m)</span>
<span class="sd">        depth : number</span>
<span class="sd">            Depth of the layer to assess the lapse rate over (m)</span>
<span class="sd"> </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        max lapse rate (C/km) : float</span>
<span class="sd">        lower pressure of max lapse rate (mb) : number</span>
<span class="sd">        upper pressure of max lapse rate (mb) : number</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">bottom_levels</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="o">-</span><span class="n">depth</span><span class="o">+</span><span class="n">interval</span><span class="p">,</span> <span class="n">interval</span><span class="p">))</span>
    <span class="n">top_levels</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lower</span><span class="o">+</span><span class="n">depth</span><span class="p">,</span> <span class="n">upper</span><span class="o">+</span><span class="n">interval</span><span class="p">,</span> <span class="n">interval</span><span class="p">))</span>
    <span class="n">bottom_pres</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">bottom_levels</span><span class="p">)</span>
    <span class="n">top_pres</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">top_levels</span><span class="p">)</span>
    <span class="n">all_lapse_rates</span> <span class="o">=</span> <span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">top_pres</span><span class="p">)</span> <span class="o">-</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">bottom_pres</span><span class="p">))</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1000.</span>
    <span class="n">max_lapse_rate_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">all_lapse_rates</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_lapse_rates</span><span class="p">[</span><span class="n">max_lapse_rate_idx</span><span class="p">]</span><span class="o">/</span><span class="n">depth</span><span class="p">,</span> <span class="n">bottom_pres</span><span class="p">[</span><span class="n">max_lapse_rate_idx</span><span class="p">],</span> <span class="n">top_pres</span><span class="p">[</span><span class="n">max_lapse_rate_idx</span><span class="p">]</span> </div>

<div class="viewcode-block" id="most_unstable_level"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.most_unstable_level">[docs]</a><span class="k">def</span> <span class="nf">most_unstable_level</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dp</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the most unstable level between the lower and upper levels.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        pbot : number (optional; default surface)</span>
<span class="sd">            Pressure of the bottom level (hPa)</span>
<span class="sd">        ptop : number (optional; default 400 hPa)</span>
<span class="sd">            Pressure of the top level (hPa)</span>
<span class="sd">        dp : negative integer (optional; default = -1)</span>
<span class="sd">            The pressure increment for the interpolated sounding (mb)</span>
<span class="sd">        exact : bool (optional; default = False)</span>
<span class="sd">            Switch to choose between using the exact data (slower) or using</span>
<span class="sd">            interpolated sounding at &#39;dp&#39; pressure levels (faster)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Pressure level of most unstable level (hPa) : number</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pbot</span><span class="p">:</span> <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ptop</span><span class="p">:</span> <span class="n">ptop</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span> <span class="o">-</span> <span class="mi">400</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)):</span> <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)):</span> <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">if</span> <span class="n">exact</span><span class="p">:</span>
        <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pbot</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ptop</span> <span class="o">&lt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">t</span><span class="o">.</span><span class="n">mask</span> <span class="o">*</span> <span class="o">~</span><span class="n">d</span><span class="o">.</span><span class="n">mask</span> <span class="o">*</span> <span class="o">~</span><span class="n">p</span><span class="o">.</span><span class="n">mask</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">t1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="p">[</span><span class="n">t2</span><span class="p">]])</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">d1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="p">[</span><span class="n">d2</span><span class="p">]])</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">pbot</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="p">[</span><span class="n">ptop</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="o">+</span><span class="n">dp</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">pbot</span><span class="p">))</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">p2</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">drylift</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">mt</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">)</span> <span class="c1"># Essentially this is making the Theta-E profile, which we are already doing in the Profile object!</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">mt</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">mt</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">TOL</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span></div>

<span class="k">def</span> <span class="nf">parcelTraj</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">parcel</span><span class="p">,</span> <span class="n">smu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parcel Trajectory Routine (Storm Slinky)</span>
<span class="sd">        Coded by Greg Blumberg</span>

<span class="sd">        This routine is a simple 3D thermodynamic parcel trajectory model that</span>
<span class="sd">        takes a thermodynamic profile and a parcel trace and computes the</span>
<span class="sd">        trajectory of a parcel that is lifted to its LFC, then given a 5 m/s</span>
<span class="sd">        nudge upwards, and then left to accelerate up to the EL.  (Based on a description</span>
<span class="sd">        in the AWIPS 2 Online Training.)</span>
<span class="sd">        </span>
<span class="sd">        This parcel is assumed to be moving horizontally via the storm motion vector, which</span>
<span class="sd">        if not supplied is taken to be the Bunkers Right Mover storm motion vector.</span>
<span class="sd">        As the parcel accelerates upwards, it is advected by the storm relative winds.</span>
<span class="sd">        The environmental winds are assumed to be steady-state.</span>
<span class="sd">        </span>
<span class="sd">        This simulates the path a parcel in a storm updraft would take using pure parcel theory.</span>
<span class="sd">        </span>
<span class="sd">        .. important:: </span>
<span class="sd">            The code for this function was not directly ported from SPC.</span>
<span class="sd"> </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        parcel : parcel object</span>
<span class="sd">            Parcel object</span>
<span class="sd">        smu : number, optional</span>
<span class="sd">            U-component of the storm motion vector (kts)</span>
<span class="sd">        smv: number, optional</span>
<span class="sd">            V-component of the storm motion vector (kts)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pos_vector : list</span>
<span class="sd">            a list of tuples, where each element of the list is a location of the parcel in time (m)</span>
<span class="sd">        theta : number</span>
<span class="sd">            the tilt of the updraft measured by the angle of the updraft with respect to the horizon (degrees)</span>
<span class="sd">        &#39;&#39;&#39;</span>
    
    <span class="n">t_parcel</span> <span class="o">=</span> <span class="n">parcel</span><span class="o">.</span><span class="n">ttrace</span> <span class="c1"># temperature</span>
    <span class="n">p_parcel</span> <span class="o">=</span> <span class="n">parcel</span><span class="o">.</span><span class="n">ptrace</span> <span class="c1"># mb</span>
    <span class="n">elhght</span> <span class="o">=</span> <span class="n">parcel</span><span class="o">.</span><span class="n">elhght</span> <span class="c1"># meter</span>
    
    <span class="n">y_0</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># meter</span>
    <span class="n">x_0</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># meter</span>
    <span class="n">z_0</span> <span class="o">=</span> <span class="n">parcel</span><span class="o">.</span><span class="n">lfchght</span> <span class="c1"># meter</span>
    <span class="n">p_0</span> <span class="o">=</span> <span class="n">parcel</span><span class="o">.</span><span class="n">lfcpres</span> <span class="c1"># meter</span>
    
    <span class="n">g</span> <span class="o">=</span> <span class="mf">9.8</span> <span class="c1"># m/s**2</span>
    <span class="n">t_0</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># seconds</span>
    <span class="n">w_0</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># m/s (the initial parcel nudge)</span>
    <span class="n">u_0</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># m/s</span>
    <span class="n">v_0</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># m/s (initial parcel location, which is storm motion relative)</span>
    
    <span class="n">delta_t</span> <span class="o">=</span> <span class="mi">25</span> <span class="c1"># the trajectory increment</span>
    <span class="n">pos_vector</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x_0</span><span class="p">,</span><span class="n">y_0</span><span class="p">,</span><span class="n">z_0</span><span class="p">)]</span>
    <span class="n">speed_vector</span> <span class="o">=</span> <span class="p">[(</span><span class="n">u_0</span><span class="p">,</span> <span class="n">v_0</span><span class="p">,</span> <span class="n">w_0</span><span class="p">)]</span>
    
    <span class="k">if</span> <span class="n">smu</span><span class="o">==</span><span class="kc">None</span> <span class="ow">or</span> <span class="n">smv</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">smu</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">srwind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Expected to be in knots</span>
        <span class="n">smv</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">srwind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Is expected to be in knots</span>

    <span class="k">if</span> <span class="n">parcel</span><span class="o">.</span><span class="n">bplus</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
        <span class="c1"># The parcel doesn&#39;t have any positively buoyant areas.</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">elhght</span><span class="p">):</span>
        <span class="n">elhght</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">hght</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">while</span> <span class="n">z_0</span> <span class="o">&lt;</span> <span class="n">elhght</span><span class="p">:</span>
        <span class="n">t_1</span> <span class="o">=</span> <span class="n">delta_t</span> <span class="o">+</span> <span class="n">t_0</span> <span class="c1"># the time step increment</span>
        
        <span class="c1"># Compute the vertical acceleration</span>
        <span class="n">env_tempv</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">p_0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">273.15</span>
        <span class="n">pcl_tempv</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">generic_interp_pres</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">p_0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">p_parcel</span><span class="o">.</span><span class="n">copy</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t_parcel</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mf">273.15</span>
        <span class="n">accel</span> <span class="o">=</span> <span class="n">g</span> <span class="o">*</span> <span class="p">((</span><span class="n">pcl_tempv</span> <span class="o">-</span> <span class="n">env_tempv</span><span class="p">)</span> <span class="o">/</span> <span class="n">env_tempv</span><span class="p">)</span>
        
        <span class="c1"># Compute the vertical displacement</span>
        <span class="n">z_1</span> <span class="o">=</span> <span class="p">(</span><span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">accel</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">t_1</span> <span class="o">-</span> <span class="n">t_0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">w_0</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_1</span> <span class="o">-</span> <span class="n">t_0</span><span class="p">))</span> <span class="o">+</span> <span class="n">z_0</span>
        <span class="n">w_1</span> <span class="o">=</span> <span class="n">accel</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_1</span> <span class="o">-</span> <span class="n">t_0</span><span class="p">)</span> <span class="o">+</span> <span class="n">w_0</span>
        
        <span class="c1"># Compute the parcel-relative winds</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">components</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">p_0</span><span class="p">)</span>
        <span class="n">u_0</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">KTS2MS</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">smu</span><span class="p">)</span>
        <span class="n">v_0</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">KTS2MS</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">smv</span><span class="p">)</span>
        
        <span class="c1"># Compute the horizontal displacements</span>
        <span class="n">x_1</span> <span class="o">=</span> <span class="n">u_0</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_1</span> <span class="o">-</span> <span class="n">t_0</span><span class="p">)</span> <span class="o">+</span> <span class="n">x_0</span>
        <span class="n">y_1</span> <span class="o">=</span> <span class="n">v_0</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_1</span> <span class="o">-</span> <span class="n">t_0</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_0</span>
        
        <span class="n">pos_vector</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x_1</span><span class="p">,</span> <span class="n">y_1</span><span class="p">,</span> <span class="n">z_1</span><span class="p">))</span>
        <span class="n">speed_vector</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">u_0</span><span class="p">,</span> <span class="n">v_0</span><span class="p">,</span> <span class="n">w_1</span><span class="p">))</span>

        <span class="c1"># Update parcel position</span>
        <span class="n">z_0</span> <span class="o">=</span> <span class="n">z_1</span>
        <span class="n">y_0</span> <span class="o">=</span> <span class="n">y_1</span>
        <span class="n">x_0</span> <span class="o">=</span> <span class="n">x_1</span>
        <span class="n">t_0</span> <span class="o">=</span> <span class="n">t_1</span>
        <span class="n">p_0</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">z_1</span><span class="p">))</span>
        
        <span class="c1"># Update parcel vertical velocity</span>
        <span class="n">w_0</span> <span class="o">=</span> <span class="n">w_1</span>
    
    <span class="c1"># Compute the angle tilt of the updraft</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">pos_vector</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">pos_vector</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">pos_vector</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">r</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pos_vector</span><span class="p">,</span> <span class="n">theta</span>

<div class="viewcode-block" id="cape"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.cape">[docs]</a><span class="k">def</span> <span class="nf">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dp</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_lifter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trunc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;        </span>
<span class="sd">        Lifts the specified parcel, calculates various levels and parameters from</span>
<span class="sd">        the profile object. Only B+/B- are calculated based on the specified layer. </span>
<span class="sd">        </span>
<span class="sd">        This is a convenience function for effective_inflow_layer and convective_temp, </span>
<span class="sd">        as well as any function that needs to lift a parcel in an iterative process.</span>
<span class="sd">        This function is a stripped back version of the parcelx function, that only</span>
<span class="sd">        handles bplus and bminus. The intention is to reduce the computation time in</span>
<span class="sd">        the iterative functions by reducing the calculations needed.</span>

<span class="sd">        This method of creating a stripped down parcelx function for CAPE/CIN calculations</span>
<span class="sd">        was developed by Greg Blumberg and Kelton Halbert and later implemented in</span>
<span class="sd">        SPC&#39;s version of SHARP to speed up their program.</span>
<span class="sd">        </span>
<span class="sd">        For full parcel objects, use the parcelx function.</span>
<span class="sd">        </span>
<span class="sd">        !! All calculations use the virtual temperature correction unless noted. !!</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        pbot : number (optional; default surface)</span>
<span class="sd">            Pressure of the bottom level (hPa)</span>
<span class="sd">        ptop : number (optional; default 400 hPa)</span>
<span class="sd">            Pressure of the top level (hPa)</span>
<span class="sd">        pres : number (optional)</span>
<span class="sd">            Pressure of parcel to lift (hPa)</span>
<span class="sd">        tmpc : number (optional)</span>
<span class="sd">            Temperature of parcel to lift (C)</span>
<span class="sd">        dwpc : number (optional)</span>
<span class="sd">            Dew Point of parcel to lift (C)</span>
<span class="sd">        dp : negative integer (optional; default = -1)</span>
<span class="sd">            The pressure increment for the interpolated sounding (mb)</span>
<span class="sd">        exact : bool (optional; default = False)</span>
<span class="sd">            Switch to choose between using the exact data (slower) or using</span>
<span class="sd">            interpolated sounding at &#39;dp&#39; pressure levels (faster)</span>
<span class="sd">        flag : number (optional; default = 5)</span>
<span class="sd">            Flag to determine what kind of parcel to create; See DefineParcel for</span>
<span class="sd">            flag values</span>
<span class="sd">        lplvals : lifting parcel layer object (optional)</span>
<span class="sd">            Contains the necessary parameters to describe a lifting parcel</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pcl : parcel object</span>
<span class="sd">            Parcel Object</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">pcl</span> <span class="o">=</span> <span class="n">Parcel</span><span class="p">(</span><span class="n">pbot</span><span class="o">=</span><span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">ptop</span><span class="p">)</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">lplvals</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lplvals&#39;</span><span class="p">,</span> <span class="n">DefineParcel</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">pcl</span>
    
    <span class="c1"># Variables</span>
    <span class="n">pres</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pres&#39;</span><span class="p">,</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lplvals</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
    <span class="n">tmpc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tmpc&#39;</span><span class="p">,</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lplvals</span><span class="o">.</span><span class="n">tmpc</span><span class="p">)</span>
    <span class="n">dwpc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dwpc&#39;</span><span class="p">,</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lplvals</span><span class="o">.</span><span class="n">dwpc</span><span class="p">)</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">pres</span> <span class="o">=</span> <span class="n">pres</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">tmpc</span> <span class="o">=</span> <span class="n">tmpc</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">dwpc</span> <span class="o">=</span> <span class="n">dwpc</span>
    <span class="n">totp</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">totn</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">cinh_old</span> <span class="o">=</span> <span class="mf">0.</span>
    
    <span class="c1"># See if default layer is specified</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pbot</span><span class="p">:</span>
        <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">blayer</span> <span class="o">=</span> <span class="n">pbot</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">pbot</span> <span class="o">=</span> <span class="n">pbot</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ptop</span><span class="p">:</span>
        <span class="n">ptop</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">tlayer</span> <span class="o">=</span> <span class="n">ptop</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">ptop</span> <span class="o">=</span> <span class="n">ptop</span>
    
    <span class="c1"># Make sure this is a valid layer</span>
    <span class="k">if</span> <span class="n">pbot</span> <span class="o">&gt;</span> <span class="n">pres</span><span class="p">:</span>
        <span class="n">pbot</span> <span class="o">=</span> <span class="n">pres</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">blayer</span> <span class="o">=</span> <span class="n">pbot</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">))</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ptop</span><span class="p">))</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pcl</span>

    <span class="c1"># Begin with the Mixing Layer</span>
    <span class="n">pe1</span> <span class="o">=</span> <span class="n">pbot</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe1</span><span class="p">)</span>
    <span class="n">tp1</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pres</span><span class="p">,</span> <span class="n">tmpc</span><span class="p">,</span> <span class="n">dwpc</span><span class="p">)</span>
    
    <span class="c1"># Lift parcel and return LCL pres (hPa) and LCL temp (C)</span>
    <span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">drylift</span><span class="p">(</span><span class="n">pres</span><span class="p">,</span> <span class="n">tmpc</span><span class="p">,</span> <span class="n">dwpc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">pe2</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pe2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pe2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pcl</span>
    <span class="n">blupper</span> <span class="o">=</span> <span class="n">pe2</span>
    
    <span class="c1"># Calculate lifted parcel theta for use in iterative CINH loop below</span>
    <span class="c1"># RECALL: lifted parcel theta is CONSTANT from LPL to LCL</span>
    <span class="n">theta_parcel</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">)</span>
    
    <span class="c1"># Environmental theta and mixing ratio at LPL</span>
    <span class="n">blmr</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">mixratio</span><span class="p">(</span><span class="n">pres</span><span class="p">,</span> <span class="n">dwpc</span><span class="p">)</span>
    
    <span class="c1"># ACCUMULATED CINH IN THE MIXING LAYER BELOW THE LCL</span>
    <span class="c1"># This will be done in &#39;dp&#39; increments and will use the virtual</span>
    <span class="c1"># temperature correction where possible</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pbot</span><span class="p">,</span> <span class="n">blupper</span><span class="o">+</span><span class="n">dp</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">pbot</span><span class="p">))</span>
    <span class="n">hh</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pp</span><span class="p">)</span>
    <span class="n">tmp_env_theta</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pp</span><span class="p">),</span> <span class="mf">1000.</span><span class="p">)</span>
    <span class="n">tmp_env_dwpt</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pp</span><span class="p">)</span>
    <span class="n">tv_env</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">tmp_env_theta</span><span class="p">,</span> <span class="n">tmp_env_dwpt</span><span class="p">)</span>
    <span class="n">tmp1</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">theta_parcel</span><span class="p">,</span> <span class="n">thermo</span><span class="o">.</span><span class="n">temp_at_mixrat</span><span class="p">(</span><span class="n">blmr</span><span class="p">,</span> <span class="n">pp</span><span class="p">))</span>
    <span class="n">tdef</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp1</span> <span class="o">-</span> <span class="n">tv_env</span><span class="p">)</span> <span class="o">/</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">tv_env</span><span class="p">)</span>

    <span class="n">lyre</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">tdef</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">hh</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">hh</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">totn</span> <span class="o">=</span> <span class="n">lyre</span><span class="p">[</span><span class="n">lyre</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">totn</span><span class="p">:</span> <span class="n">totn</span> <span class="o">=</span> <span class="mf">0.</span>
   
    <span class="c1"># TODO: Because this function is used often to search for parcels that meet a certain</span>
    <span class="c1">#       CAPE/CIN threshold, we can add a few statments here and there in the code</span>
    <span class="c1">#       that checks to see if these thresholds are met and if they are, return a flag.</span>
    <span class="c1">#       We don&#39;t need to call wetlift() anymore than we need to.  This is one location</span>
    <span class="c1">#       where we can do this.  If the CIN is too large, return here...don&#39;t have to worry</span>
    <span class="c1">#       about ever entering the loop!</span>
 
    <span class="c1"># Move the bottom layer to the top of the boundary layer</span>
    <span class="k">if</span> <span class="n">pbot</span> <span class="o">&gt;</span> <span class="n">pe2</span><span class="p">:</span>
        <span class="n">pbot</span> <span class="o">=</span> <span class="n">pe2</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">blayer</span> <span class="o">=</span> <span class="n">pbot</span>

    <span class="k">if</span> <span class="n">pbot</span> <span class="o">&lt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="c1"># Check for the case where the LCL is above the </span>
        <span class="c1"># upper boundary of the data (e.g. a dropsonde)</span>
        <span class="k">return</span> <span class="n">pcl</span>
    
    <span class="c1"># Find lowest observation in layer</span>
    <span class="n">lptr</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pbot</span> <span class="o">&gt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">uptr</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ptop</span> <span class="o">&lt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    
    <span class="c1"># START WITH INTERPOLATED BOTTOM LAYER</span>
    <span class="c1"># Begin moist ascent from lifted parcel LCL (pe2, tp2)</span>
    <span class="n">pe1</span> <span class="o">=</span> <span class="n">pbot</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe1</span><span class="p">)</span>
    <span class="n">te1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe1</span><span class="p">)</span>
    <span class="n">tp1</span> <span class="o">=</span> <span class="n">tp2</span>
    <span class="n">lyre</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">new_lifter</span><span class="p">:</span>
        <span class="n">env_temp</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">vtmp</span><span class="p">[</span><span class="n">lptr</span><span class="p">:]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="o">~</span><span class="n">env_temp</span><span class="o">.</span><span class="n">mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">env_temp</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">env_temp</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">env_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">te1</span><span class="p">,</span> <span class="n">env_temp</span><span class="p">[</span><span class="n">keep</span><span class="p">])</span>
        <span class="n">env_pres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">lptr</span><span class="p">:][</span><span class="n">keep</span><span class="p">])</span>
        <span class="n">env_hght</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">hght</span><span class="p">[</span><span class="n">lptr</span><span class="p">:][</span><span class="n">keep</span><span class="p">])</span>
        <span class="n">pcl_temp</span> <span class="o">=</span> <span class="n">integrate_parcel</span><span class="p">(</span><span class="n">env_pres</span><span class="p">,</span> <span class="n">tp1</span><span class="p">)</span>
        <span class="n">tdef</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">env_pres</span><span class="p">,</span> <span class="n">pcl_temp</span><span class="p">,</span> <span class="n">pcl_temp</span><span class="p">)</span> <span class="o">-</span> <span class="n">env_temp</span><span class="p">)</span> <span class="o">/</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">env_temp</span><span class="p">)</span>
        <span class="n">lyre</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">tdef</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">env_hght</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">env_hght</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">totp</span> <span class="o">=</span> <span class="n">lyre</span><span class="p">[</span><span class="n">lyre</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">neg_layers</span> <span class="o">=</span> <span class="p">(</span><span class="n">lyre</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">env_pres</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">neg_layers</span><span class="p">):</span>
            <span class="n">totn</span> <span class="o">+=</span> <span class="n">lyre</span><span class="p">[</span><span class="n">neg_layers</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">lyre</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">=</span> <span class="n">totp</span> <span class="o">-</span> <span class="n">lyre</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="n">totn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">=</span> <span class="n">totp</span>
            <span class="k">if</span> <span class="n">env_pres</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">500.</span><span class="p">:</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="n">totn</span> <span class="o">+</span> <span class="n">lyre</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="n">totn</span>

        <span class="k">if</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lptr</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span> <span class="k">continue</span>
            <span class="n">pe2</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">h2</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">hght</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">te2</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">vtmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">tp2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
            <span class="n">tdef1</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">)</span> <span class="o">-</span> <span class="n">te1</span><span class="p">)</span> <span class="o">/</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te1</span><span class="p">)</span>
            <span class="n">tdef2</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">)</span> <span class="o">-</span> <span class="n">te2</span><span class="p">)</span> <span class="o">/</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te2</span><span class="p">)</span>
            <span class="n">lyre</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef1</span> <span class="o">+</span> <span class="n">tdef2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">h2</span> <span class="o">-</span> <span class="n">h1</span><span class="p">)</span>
            
            <span class="c1"># Add layer energy to total positive if lyre &gt; 0</span>
            <span class="k">if</span> <span class="n">lyre</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">totp</span> <span class="o">+=</span> <span class="n">lyre</span>
            <span class="c1"># Add layer energy to total negative if lyre &lt; 0, only up to EL</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pe2</span> <span class="o">&gt;</span> <span class="mf">500.</span><span class="p">:</span> <span class="n">totn</span> <span class="o">+=</span> <span class="n">lyre</span>

            <span class="n">pe1</span> <span class="o">=</span> <span class="n">pe2</span>
            <span class="n">h1</span> <span class="o">=</span> <span class="n">h2</span>
            <span class="n">te1</span> <span class="o">=</span> <span class="n">te2</span>
            <span class="n">tp1</span> <span class="o">=</span> <span class="n">tp2</span>
            <span class="c1"># Is this the top of the specified layer</span>
            <span class="c1"># Because CIN is only computed below 500 mb, we can cut off additional lifting when</span>
            <span class="c1"># computing convective temperature!</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">trunc</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">pe2</span> <span class="o">&lt;=</span> <span class="mi">500</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">uptr</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span><span class="p">)):</span>
                <span class="n">pe3</span> <span class="o">=</span> <span class="n">pe1</span>
                <span class="n">h3</span> <span class="o">=</span> <span class="n">h1</span>
                <span class="n">te3</span> <span class="o">=</span> <span class="n">te1</span>
                <span class="n">tp3</span> <span class="o">=</span> <span class="n">tp1</span>
                <span class="n">lyrf</span> <span class="o">=</span> <span class="n">lyre</span>
                <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">=</span> <span class="n">totp</span> <span class="o">-</span> <span class="n">lyrf</span>
                    <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="n">totn</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">=</span> <span class="n">totp</span>
                    <span class="k">if</span> <span class="n">pe2</span> <span class="o">&gt;</span> <span class="mf">500.</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="n">totn</span> <span class="o">+</span> <span class="n">lyrf</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="n">totn</span>
                <span class="n">pe2</span> <span class="o">=</span> <span class="n">ptop</span>
                <span class="n">h2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
                <span class="n">te2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
                <span class="n">tp2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
                <span class="n">tdef3</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">)</span> <span class="o">-</span> <span class="n">te3</span><span class="p">)</span> <span class="o">/</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te3</span><span class="p">)</span>
                <span class="n">tdef2</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">)</span> <span class="o">-</span> <span class="n">te2</span><span class="p">)</span> <span class="o">/</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te2</span><span class="p">)</span>
                <span class="n">lyrf</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef3</span> <span class="o">+</span> <span class="n">tdef2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">h2</span> <span class="o">-</span> <span class="n">h3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">+=</span> <span class="n">lyrf</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pe2</span> <span class="o">&gt;</span> <span class="mf">500.</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">+=</span> <span class="n">lyrf</span>
                <span class="k">if</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">pcl</span></div>


<div class="viewcode-block" id="integrate_parcel"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.integrate_parcel">[docs]</a><span class="k">def</span> <span class="nf">integrate_parcel</span><span class="p">(</span><span class="n">pres</span><span class="p">,</span> <span class="n">tbot</span><span class="p">):</span>
    <span class="n">pcl_tmpc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">pres</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pres</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">pcl_tmpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbot</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pres</span><span class="p">)):</span>
        <span class="n">pcl_tmpc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pres</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pcl_tmpc</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pres</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">pcl_tmpc</span></div>


<div class="viewcode-block" id="parcelx"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.parcelx">[docs]</a><span class="k">def</span> <span class="nf">parcelx</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dp</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Lifts the specified parcel, calculates various levels and parameters from</span>
<span class="sd">        the profile object. B+/B- are calculated based on the specified layer.</span>
<span class="sd">        Such parameters include CAPE, CIN, LCL height, LFC height, buoyancy minimum,</span>
<span class="sd">        EL height, MPL height.</span>
<span class="sd">        </span>
<span class="sd">        !! All calculations use the virtual temperature correction unless noted. !!</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        pbot : number (optional; default surface)</span>
<span class="sd">            Pressure of the bottom level (hPa)</span>
<span class="sd">        ptop : number (optional; default 400 hPa)</span>
<span class="sd">            Pressure of the top level (hPa)</span>
<span class="sd">        pres : number (optional)</span>
<span class="sd">            Pressure of parcel to lift (hPa)</span>
<span class="sd">        tmpc : number (optional)</span>
<span class="sd">            Temperature of parcel to lift (C)</span>
<span class="sd">        dwpc : number (optional)</span>
<span class="sd">            Dew Point of parcel to lift (C)</span>
<span class="sd">        dp : negative integer (optional; default = -1)</span>
<span class="sd">            The pressure increment for the interpolated sounding (mb)</span>
<span class="sd">        exact : bool (optional; default = False)</span>
<span class="sd">            Switch to choose between using the exact data (slower) or using</span>
<span class="sd">            interpolated sounding at &#39;dp&#39; pressure levels (faster)</span>
<span class="sd">        flag : number (optional; default = 5)</span>
<span class="sd">            Flag to determine what kind of parcel to create; See DefineParcel for</span>
<span class="sd">            flag values</span>
<span class="sd">        lplvals : lifting parcel layer object (optional)</span>
<span class="sd">            Contains the necessary parameters to describe a lifting parcel</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            Parcel Object</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">pcl</span> <span class="o">=</span> <span class="n">Parcel</span><span class="p">(</span><span class="n">pbot</span><span class="o">=</span><span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">ptop</span><span class="p">)</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">lplvals</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lplvals&#39;</span><span class="p">,</span> <span class="n">DefineParcel</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">pcl</span>
    
    <span class="c1"># Variables</span>
    <span class="n">pres</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pres&#39;</span><span class="p">,</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lplvals</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
    <span class="n">tmpc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tmpc&#39;</span><span class="p">,</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lplvals</span><span class="o">.</span><span class="n">tmpc</span><span class="p">)</span>
    <span class="n">dwpc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dwpc&#39;</span><span class="p">,</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lplvals</span><span class="o">.</span><span class="n">dwpc</span><span class="p">)</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">pres</span> <span class="o">=</span> <span class="n">pres</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">tmpc</span> <span class="o">=</span> <span class="n">tmpc</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">dwpc</span> <span class="o">=</span> <span class="n">dwpc</span>
    <span class="n">cap_strength</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.</span>
    <span class="n">cap_strengthpres</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.</span>
    <span class="n">li_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.</span>
    <span class="n">li_maxpres</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.</span>
    <span class="n">totp</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">totn</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">tote</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">cinh_old</span> <span class="o">=</span> <span class="mf">0.</span>
    
    <span class="c1"># See if default layer is specified</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pbot</span><span class="p">:</span>
        <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">blayer</span> <span class="o">=</span> <span class="n">pbot</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">pbot</span> <span class="o">=</span> <span class="n">pbot</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ptop</span><span class="p">:</span>
        <span class="n">ptop</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">tlayer</span> <span class="o">=</span> <span class="n">ptop</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">ptop</span> <span class="o">=</span> <span class="n">ptop</span>
    <span class="c1"># Make sure this is a valid layer</span>
    <span class="k">if</span> <span class="n">pbot</span> <span class="o">&gt;</span> <span class="n">pres</span><span class="p">:</span>
        <span class="n">pbot</span> <span class="o">=</span> <span class="n">pres</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">blayer</span> <span class="o">=</span> <span class="n">pbot</span>

    <span class="c1">#if type(interp.vtmp(prof, pbot)) == type(ma.masked) or type(interp.vtmp(prof, ptop)) == type(ma.masked):</span>
    <span class="c1">#    return pcl</span>

    <span class="c1"># Begin with the Mixing Layer</span>
    <span class="n">pe1</span> <span class="o">=</span> <span class="n">pbot</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe1</span><span class="p">)</span>
    <span class="n">tp1</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pres</span><span class="p">,</span> <span class="n">tmpc</span><span class="p">,</span> <span class="n">dwpc</span><span class="p">)</span>
    <span class="n">ttrace</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp1</span><span class="p">]</span>
    <span class="n">ptrace</span> <span class="o">=</span> <span class="p">[</span><span class="n">pe1</span><span class="p">]</span>
    
    <span class="c1"># Lift parcel and return LCL pres (hPa) and LCL temp (C)</span>
    <span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">drylift</span><span class="p">(</span><span class="n">pres</span><span class="p">,</span> <span class="n">tmpc</span><span class="p">,</span> <span class="n">dwpc</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pe2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pe2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pcl</span>
    <span class="n">blupper</span> <span class="o">=</span> <span class="n">pe2</span>
    <span class="n">h2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
    <span class="n">te2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">lclpres</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">])</span> <span class="c1"># Make sure the LCL pressure is</span>
                                                <span class="c1"># never below the surface</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">lclhght</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_agl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">h2</span><span class="p">)</span>
    <span class="n">ptrace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pe2</span><span class="p">)</span>
    <span class="n">ttrace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">))</span>
    
    <span class="c1"># Calculate lifted parcel theta for use in iterative CINH loop below</span>
    <span class="c1"># RECALL: lifted parcel theta is CONSTANT from LPL to LCL</span>
    <span class="n">theta_parcel</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">)</span>
    
    <span class="c1"># Environmental theta and mixing ratio at LPL</span>
    <span class="n">bltheta</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">pres</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pres</span><span class="p">),</span> <span class="mf">1000.</span><span class="p">)</span>
    <span class="n">blmr</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">mixratio</span><span class="p">(</span><span class="n">pres</span><span class="p">,</span> <span class="n">dwpc</span><span class="p">)</span>
    
    <span class="c1"># ACCUMULATED CINH IN THE MIXING LAYER BELOW THE LCL</span>
    <span class="c1"># This will be done in &#39;dp&#39; increments and will use the virtual</span>
    <span class="c1"># temperature correction where possible</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pbot</span><span class="p">,</span> <span class="n">blupper</span><span class="o">+</span><span class="n">dp</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">pbot</span><span class="p">))</span>
    <span class="n">hh</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pp</span><span class="p">)</span>
    <span class="n">tmp_env_theta</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pp</span><span class="p">),</span> <span class="mf">1000.</span><span class="p">)</span>
    <span class="n">tmp_env_dwpt</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pp</span><span class="p">)</span>
    <span class="n">tv_env</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">tmp_env_theta</span><span class="p">,</span> <span class="n">tmp_env_dwpt</span><span class="p">)</span>
    <span class="n">tmp1</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">theta_parcel</span><span class="p">,</span> <span class="n">thermo</span><span class="o">.</span><span class="n">temp_at_mixrat</span><span class="p">(</span><span class="n">blmr</span><span class="p">,</span> <span class="n">pp</span><span class="p">))</span>
    <span class="n">tdef</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp1</span> <span class="o">-</span> <span class="n">tv_env</span><span class="p">)</span> <span class="o">/</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">tv_env</span><span class="p">)</span>

    <span class="n">tidx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tdef</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">tidx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tdef</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">lyre</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef</span><span class="p">[</span><span class="n">tidx1</span><span class="p">]</span><span class="o">+</span><span class="n">tdef</span><span class="p">[</span><span class="n">tidx2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">hh</span><span class="p">[</span><span class="n">tidx2</span><span class="p">]</span><span class="o">-</span><span class="n">hh</span><span class="p">[</span><span class="n">tidx1</span><span class="p">])</span>
    <span class="n">totn</span> <span class="o">=</span> <span class="n">lyre</span><span class="p">[</span><span class="n">lyre</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">totn</span><span class="p">:</span> <span class="n">totn</span> <span class="o">=</span> <span class="mf">0.</span>
    
    <span class="c1"># Move the bottom layer to the top of the boundary layer</span>
    <span class="k">if</span> <span class="n">pbot</span> <span class="o">&gt;</span> <span class="n">pe2</span><span class="p">:</span>
        <span class="n">pbot</span> <span class="o">=</span> <span class="n">pe2</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">blayer</span> <span class="o">=</span> <span class="n">pbot</span>
    
    <span class="c1"># Calculate height of various temperature levels</span>
    <span class="n">p0c</span> <span class="o">=</span> <span class="n">temp_lvl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">pm10c</span> <span class="o">=</span> <span class="n">temp_lvl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.</span><span class="p">)</span>
    <span class="n">pm20c</span> <span class="o">=</span> <span class="n">temp_lvl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">-</span><span class="mf">20.</span><span class="p">)</span>
    <span class="n">pm30c</span> <span class="o">=</span> <span class="n">temp_lvl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">-</span><span class="mf">30.</span><span class="p">)</span>
    <span class="n">hgt0c</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">p0c</span><span class="p">)</span>
    <span class="n">hgtm10c</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pm10c</span><span class="p">)</span>
    <span class="n">hgtm20c</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pm20c</span><span class="p">)</span>
    <span class="n">hgtm30c</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pm30c</span><span class="p">)</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">p0c</span> <span class="o">=</span> <span class="n">p0c</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">pm10c</span> <span class="o">=</span> <span class="n">pm10c</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">pm20c</span> <span class="o">=</span> <span class="n">pm20c</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">pm30c</span> <span class="o">=</span> <span class="n">pm30c</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">hght0c</span> <span class="o">=</span> <span class="n">hgt0c</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">hghtm10c</span> <span class="o">=</span> <span class="n">hgtm10c</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">hghtm20c</span> <span class="o">=</span> <span class="n">hgtm20c</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">hghtm30c</span> <span class="o">=</span> <span class="n">hgtm30c</span>

    <span class="k">if</span> <span class="n">pbot</span> <span class="o">&lt;</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="c1"># Check for the case where the LCL is above the </span>
        <span class="c1"># upper boundary of the data (e.g. a dropsonde)</span>
        <span class="k">return</span> <span class="n">pcl</span>

    <span class="c1"># Find lowest observation in layer</span>
    <span class="n">lptr</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pbot</span> <span class="o">&gt;=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">uptr</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ptop</span> <span class="o">&lt;=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    
    <span class="c1"># START WITH INTERPOLATED BOTTOM LAYER</span>
    <span class="c1"># Begin moist ascent from lifted parcel LCL (pe2, tp2)</span>
    <span class="n">pe1</span> <span class="o">=</span> <span class="n">pbot</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe1</span><span class="p">)</span>
    <span class="n">te1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe1</span><span class="p">)</span>
    <span class="n">tp1</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">pe1</span><span class="p">)</span>
    <span class="n">lyre</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lyrlast</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">iter_ranges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lptr</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ttraces</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iter_ranges</span><span class="p">))</span>
    <span class="n">ptraces</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iter_ranges</span><span class="p">))</span>
    <span class="n">ttraces</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ptraces</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iter_ranges</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span> <span class="k">continue</span>
        <span class="n">pe2</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">hght</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">te2</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">vtmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1">#te2 = thermo.virtemp(prof.pres[i], prof.tmpc[i], prof.dwpc[i])</span>
        <span class="n">tp2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
        <span class="n">tdef1</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">)</span> <span class="o">-</span> <span class="n">te1</span><span class="p">)</span> <span class="o">/</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te1</span><span class="p">)</span>
        <span class="n">tdef2</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">)</span> <span class="o">-</span> <span class="n">te2</span><span class="p">)</span> <span class="o">/</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te2</span><span class="p">)</span>

        <span class="n">ptraces</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">iter_ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pe2</span>
        <span class="n">ttraces</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">iter_ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">)</span>
        <span class="n">lyrlast</span> <span class="o">=</span> <span class="n">lyre</span>
        <span class="n">lyre</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef1</span> <span class="o">+</span> <span class="n">tdef2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">h2</span> <span class="o">-</span> <span class="n">h1</span><span class="p">)</span>

        <span class="c1">#print(pe1, pe2, te1, te2, tp1, tp2, lyre, totp, totn, pcl.lfcpres)</span>

        <span class="c1"># Add layer energy to total positive if lyre &gt; 0</span>
        <span class="k">if</span> <span class="n">lyre</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">totp</span> <span class="o">+=</span> <span class="n">lyre</span>
        <span class="c1"># Add layer energy to total negative if lyre &lt; 0, only up to EL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pe2</span> <span class="o">&gt;</span> <span class="mf">500.</span><span class="p">:</span> <span class="n">totn</span> <span class="o">+=</span> <span class="n">lyre</span>
        
        <span class="c1"># Check for Max LI</span>
        <span class="n">mli</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">)</span> <span class="o">-</span> <span class="n">te2</span>
        <span class="k">if</span>  <span class="n">mli</span> <span class="o">&gt;</span> <span class="n">li_max</span><span class="p">:</span>
            <span class="n">li_max</span> <span class="o">=</span> <span class="n">mli</span>
            <span class="n">li_maxpres</span> <span class="o">=</span> <span class="n">pe2</span>
        
        <span class="c1"># Check for Max Cap Strength</span>
        <span class="n">mcap</span> <span class="o">=</span> <span class="n">te2</span> <span class="o">-</span> <span class="n">mli</span>
        <span class="k">if</span> <span class="n">mcap</span> <span class="o">&gt;</span> <span class="n">cap_strength</span><span class="p">:</span>
            <span class="n">cap_strength</span> <span class="o">=</span> <span class="n">mcap</span>
            <span class="n">cap_strengthpres</span> <span class="o">=</span> <span class="n">pe2</span>
        
        <span class="n">tote</span> <span class="o">+=</span> <span class="n">lyre</span>
        <span class="n">pelast</span> <span class="o">=</span> <span class="n">pe1</span>
        <span class="n">pe1</span> <span class="o">=</span> <span class="n">pe2</span>
        <span class="n">te1</span> <span class="o">=</span> <span class="n">te2</span>
        <span class="n">tp1</span> <span class="o">=</span> <span class="n">tp2</span>
        
        <span class="c1"># Is this the top of the specified layer</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">uptr</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span><span class="p">):</span>
            <span class="n">pe3</span> <span class="o">=</span> <span class="n">pe1</span>
            <span class="n">h3</span> <span class="o">=</span> <span class="n">h2</span>
            <span class="n">te3</span> <span class="o">=</span> <span class="n">te1</span>
            <span class="n">tp3</span> <span class="o">=</span> <span class="n">tp1</span>
            <span class="n">lyrf</span> <span class="o">=</span> <span class="n">lyre</span>
            <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">=</span> <span class="n">totp</span> <span class="o">-</span> <span class="n">lyrf</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="n">totn</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">=</span> <span class="n">totp</span>
                <span class="k">if</span> <span class="n">pe2</span> <span class="o">&gt;</span> <span class="mf">500.</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="n">totn</span> <span class="o">+</span> <span class="n">lyrf</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="n">totn</span>
            <span class="n">pe2</span> <span class="o">=</span> <span class="n">ptop</span>
            <span class="n">h2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
            <span class="n">te2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
            <span class="n">tp2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
            <span class="n">tdef3</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">)</span> <span class="o">-</span> <span class="n">te3</span><span class="p">)</span> <span class="o">/</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te3</span><span class="p">)</span>
            <span class="n">tdef2</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">)</span> <span class="o">-</span> <span class="n">te2</span><span class="p">)</span> <span class="o">/</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te2</span><span class="p">)</span>
            <span class="n">lyrf</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef3</span> <span class="o">+</span> <span class="n">tdef2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">h2</span> <span class="o">-</span> <span class="n">h3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">+=</span> <span class="n">lyrf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pe2</span> <span class="o">&gt;</span> <span class="mf">500.</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">+=</span> <span class="n">lyrf</span>
            <span class="k">if</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="mf">0.</span>
        
        <span class="c1"># Is this the freezing level</span>
        <span class="k">if</span> <span class="n">te2</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">bfzl</span><span class="p">):</span>
            <span class="n">pe3</span> <span class="o">=</span> <span class="n">pelast</span>
            <span class="n">h3</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">te3</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">tp3</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">lyrf</span> <span class="o">=</span> <span class="n">lyre</span>
            <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bfzl</span> <span class="o">=</span> <span class="n">totp</span> <span class="o">-</span> <span class="n">lyrf</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bfzl</span> <span class="o">=</span> <span class="n">totp</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">p0c</span><span class="p">)</span> <span class="ow">or</span> <span class="n">p0c</span> <span class="o">&gt;</span> <span class="n">pe3</span><span class="p">:</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">bfzl</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pe2</span><span class="p">):</span>
                <span class="n">te2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
                <span class="n">tp2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
                <span class="n">tdef3</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">)</span> <span class="o">-</span> <span class="n">te3</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te3</span><span class="p">)</span>
                <span class="n">tdef2</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">)</span> <span class="o">-</span> <span class="n">te2</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te2</span><span class="p">)</span>
                <span class="n">lyrf</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef3</span> <span class="o">+</span> <span class="n">tdef2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">hgt0c</span> <span class="o">-</span> <span class="n">h3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bfzl</span> <span class="o">+=</span> <span class="n">lyrf</span>
        
        <span class="c1"># Is this the -10C level</span>
        <span class="k">if</span> <span class="n">te2</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">10.</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">wm10c</span><span class="p">):</span>
            <span class="n">pe3</span> <span class="o">=</span> <span class="n">pelast</span>
            <span class="n">h3</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">te3</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">tp3</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">lyrf</span> <span class="o">=</span> <span class="n">lyre</span>
            <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">wm10c</span> <span class="o">=</span> <span class="n">totp</span> <span class="o">-</span> <span class="n">lyrf</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">wm10c</span> <span class="o">=</span> <span class="n">totp</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pm10c</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pm10c</span> <span class="o">&gt;</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lclpres</span><span class="p">:</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">wm10c</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pe2</span><span class="p">):</span>
                <span class="n">te2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
                <span class="n">tp2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
                <span class="n">tdef3</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">)</span> <span class="o">-</span> <span class="n">te3</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te3</span><span class="p">)</span>
                <span class="n">tdef2</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">)</span> <span class="o">-</span> <span class="n">te2</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te2</span><span class="p">)</span>
                <span class="n">lyrf</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef3</span> <span class="o">+</span> <span class="n">tdef2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">hgtm10c</span> <span class="o">-</span> <span class="n">h3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">wm10c</span> <span class="o">+=</span> <span class="n">lyrf</span>
        
        <span class="c1"># Is this the -20C level</span>
        <span class="k">if</span> <span class="n">te2</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">20.</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">wm20c</span><span class="p">):</span>
            <span class="n">pe3</span> <span class="o">=</span> <span class="n">pelast</span>
            <span class="n">h3</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">te3</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">tp3</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">lyrf</span> <span class="o">=</span> <span class="n">lyre</span>
            <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">wm20c</span> <span class="o">=</span> <span class="n">totp</span> <span class="o">-</span> <span class="n">lyrf</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">wm20c</span> <span class="o">=</span> <span class="n">totp</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pm20c</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pm20c</span> <span class="o">&gt;</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lclpres</span><span class="p">:</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">wm20c</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pe2</span><span class="p">):</span>
                <span class="n">te2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
                <span class="n">tp2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
                <span class="n">tdef3</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">)</span> <span class="o">-</span> <span class="n">te3</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te3</span><span class="p">)</span>
                <span class="n">tdef2</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">)</span> <span class="o">-</span> <span class="n">te2</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te2</span><span class="p">)</span>
                <span class="n">lyrf</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef3</span> <span class="o">+</span> <span class="n">tdef2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">hgtm20c</span> <span class="o">-</span> <span class="n">h3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">wm20c</span> <span class="o">+=</span> <span class="n">lyrf</span>
        
        <span class="c1"># Is this the -30C level</span>
        <span class="k">if</span> <span class="n">te2</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">30.</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">wm30c</span><span class="p">):</span>
            <span class="n">pe3</span> <span class="o">=</span> <span class="n">pelast</span>
            <span class="n">h3</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">te3</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">tp3</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">lyrf</span> <span class="o">=</span> <span class="n">lyre</span>
            <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">wm30c</span> <span class="o">=</span> <span class="n">totp</span> <span class="o">-</span> <span class="n">lyrf</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">wm30c</span> <span class="o">=</span> <span class="n">totp</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pm30c</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pm30c</span> <span class="o">&gt;</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lclpres</span><span class="p">:</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">wm30c</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pe2</span><span class="p">):</span>
                <span class="n">te2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
                <span class="n">tp2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
                <span class="n">tdef3</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">)</span> <span class="o">-</span> <span class="n">te3</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te3</span><span class="p">)</span>
                <span class="n">tdef2</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">)</span> <span class="o">-</span> <span class="n">te2</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te2</span><span class="p">)</span>
                <span class="n">lyrf</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef3</span> <span class="o">+</span> <span class="n">tdef2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">hgtm30c</span> <span class="o">-</span> <span class="n">h3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">wm30c</span> <span class="o">+=</span> <span class="n">lyrf</span>
        
        <span class="c1"># Is this the 3km level</span>
        <span class="k">if</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lclhght</span> <span class="o">&lt;</span> <span class="mf">3000.</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_agl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">h1</span><span class="p">)</span> <span class="o">&lt;=</span><span class="mf">3000.</span> <span class="ow">and</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_agl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">h2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">3000.</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">b3km</span><span class="p">):</span>
                <span class="n">pe3</span> <span class="o">=</span> <span class="n">pelast</span>
                <span class="n">h3</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
                <span class="n">te3</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
                <span class="n">tp3</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
                <span class="n">lyrf</span> <span class="o">=</span> <span class="n">lyre</span>
                <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">b3km</span> <span class="o">=</span> <span class="n">totp</span> <span class="o">-</span> <span class="n">lyrf</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">b3km</span> <span class="o">=</span> <span class="n">totp</span>
                <span class="n">h4</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">3000.</span><span class="p">)</span>
                <span class="n">pe4</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">h4</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pe2</span><span class="p">):</span>
                    <span class="n">te2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe4</span><span class="p">)</span>
                    <span class="n">tp2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe4</span><span class="p">)</span>
                    <span class="n">tdef3</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">)</span> <span class="o">-</span> <span class="n">te3</span><span class="p">)</span> <span class="o">/</span> \
                        <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te3</span><span class="p">)</span>
                    <span class="n">tdef2</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe4</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">)</span> <span class="o">-</span> <span class="n">te2</span><span class="p">)</span> <span class="o">/</span> \
                        <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te2</span><span class="p">)</span>
                    <span class="n">lyrf</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef3</span> <span class="o">+</span> <span class="n">tdef2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">h4</span> <span class="o">-</span> <span class="n">h3</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">b3km</span> <span class="o">+=</span> <span class="n">lyrf</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">b3km</span> <span class="o">=</span> <span class="mf">0.</span>
        
        <span class="c1"># Is this the 6km level</span>
        <span class="k">if</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lclhght</span> <span class="o">&lt;</span> <span class="mf">6000.</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_agl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">h1</span><span class="p">)</span> <span class="o">&lt;=</span><span class="mf">6000.</span> <span class="ow">and</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_agl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">h2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">6000.</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">b6km</span><span class="p">):</span>
                <span class="n">pe3</span> <span class="o">=</span> <span class="n">pelast</span>
                <span class="n">h3</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
                <span class="n">te3</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
                <span class="n">tp3</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
                <span class="n">lyrf</span> <span class="o">=</span> <span class="n">lyre</span>
                <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">b6km</span> <span class="o">=</span> <span class="n">totp</span> <span class="o">-</span> <span class="n">lyrf</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">b6km</span> <span class="o">=</span> <span class="n">totp</span>
                <span class="n">h4</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">6000.</span><span class="p">)</span>
                <span class="n">pe4</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">h4</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pe2</span><span class="p">):</span>
                    <span class="n">te2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe4</span><span class="p">)</span>
                    <span class="n">tp2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe4</span><span class="p">)</span>
                    <span class="n">tdef3</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">)</span> <span class="o">-</span> <span class="n">te3</span><span class="p">)</span> <span class="o">/</span> \
                        <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te3</span><span class="p">)</span>
                    <span class="n">tdef2</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe4</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">)</span> <span class="o">-</span> <span class="n">te2</span><span class="p">)</span> <span class="o">/</span> \
                        <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te2</span><span class="p">)</span>
                    <span class="n">lyrf</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef3</span> <span class="o">+</span> <span class="n">tdef2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">h4</span> <span class="o">-</span> <span class="n">h3</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">lyrf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">b6km</span> <span class="o">+=</span> <span class="n">lyrf</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">b6km</span> <span class="o">=</span> <span class="mf">0.</span>
        
        <span class="n">h1</span> <span class="o">=</span> <span class="n">h2</span>

        <span class="c1"># LFC Possibility</span>
        <span class="k">if</span> <span class="n">lyre</span> <span class="o">&gt;=</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">lyrlast</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">tp3</span> <span class="o">=</span> <span class="n">tp1</span>
            <span class="c1">#te3 = te1</span>
            <span class="n">pe2</span> <span class="o">=</span> <span class="n">pe1</span>
            <span class="n">pe3</span> <span class="o">=</span> <span class="n">pelast</span>
            <span class="k">if</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe3</span><span class="p">),</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)):</span>
                <span class="c1"># Found an LFC, store height/pres and reset EL/MPL</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">lfcpres</span> <span class="o">=</span> <span class="n">pe3</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">lfchght</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_agl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">))</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">elpres</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">elhght</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">mplpres</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe3</span><span class="p">),</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe3</span><span class="p">))</span> <span class="ow">and</span> <span class="n">pe3</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pe3</span> <span class="o">-=</span> <span class="mi">5</span>
                <span class="k">if</span> <span class="n">pe3</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Found a LFC, store height/pres and reset EL/MPL</span>
                    <span class="n">pcl</span><span class="o">.</span><span class="n">lfcpres</span> <span class="o">=</span> <span class="n">pe3</span>
                    <span class="n">pcl</span><span class="o">.</span><span class="n">lfchght</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_agl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">))</span>
                    <span class="n">cinh_old</span> <span class="o">=</span> <span class="n">totn</span>
                    <span class="n">tote</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="n">li_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.</span>
                    <span class="k">if</span> <span class="n">cap_strength</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="n">cap_strength</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="n">pcl</span><span class="o">.</span><span class="n">cap</span> <span class="o">=</span> <span class="n">cap_strength</span>
                    <span class="n">pcl</span><span class="o">.</span><span class="n">cappres</span> <span class="o">=</span> <span class="n">cap_strengthpres</span>

                    <span class="n">pcl</span><span class="o">.</span><span class="n">elpres</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
                    <span class="n">pcl</span><span class="o">.</span><span class="n">elhght</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
                    <span class="n">pcl</span><span class="o">.</span><span class="n">mplpres</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>

            <span class="c1"># Hack to force LFC to be at least at the LCL</span>
            <span class="k">if</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lfcpres</span> <span class="o">&gt;=</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lclpres</span><span class="p">:</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">lfcpres</span> <span class="o">=</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lclpres</span>
                <span class="n">pcl</span><span class="o">.</span><span class="n">lfchght</span> <span class="o">=</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lclhght</span>

        <span class="c1"># EL Possibility</span>
        <span class="k">if</span> <span class="n">lyre</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">lyrlast</span> <span class="o">&gt;=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">tp3</span> <span class="o">=</span> <span class="n">tp1</span>
            <span class="c1">#te3 = te1</span>
            <span class="n">pe2</span> <span class="o">=</span> <span class="n">pe1</span>
            <span class="n">pe3</span> <span class="o">=</span> <span class="n">pelast</span>
            <span class="k">while</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe3</span><span class="p">),</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)):</span>
                <span class="n">pe3</span> <span class="o">-=</span> <span class="mi">5</span>
            <span class="n">pcl</span><span class="o">.</span><span class="n">elpres</span> <span class="o">=</span> <span class="n">pe3</span>
            <span class="n">pcl</span><span class="o">.</span><span class="n">elhght</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_agl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pcl</span><span class="o">.</span><span class="n">elpres</span><span class="p">))</span>
            <span class="n">pcl</span><span class="o">.</span><span class="n">mplpres</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
            <span class="n">pcl</span><span class="o">.</span><span class="n">limax</span> <span class="o">=</span> <span class="o">-</span><span class="n">li_max</span>
            <span class="n">pcl</span><span class="o">.</span><span class="n">limaxpres</span> <span class="o">=</span> <span class="n">li_maxpres</span>
        
        <span class="c1"># MPL Possibility</span>
        <span class="k">if</span> <span class="n">tote</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">mplpres</span><span class="p">)</span> <span class="ow">and</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">elpres</span><span class="p">):</span>
            <span class="n">pe3</span> <span class="o">=</span> <span class="n">pelast</span>
            <span class="n">h3</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">te3</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">tp3</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="n">pe3</span><span class="p">)</span>
            <span class="n">totx</span> <span class="o">=</span> <span class="n">tote</span> <span class="o">-</span> <span class="n">lyre</span>
            <span class="n">pe2</span> <span class="o">=</span> <span class="n">pelast</span>
            <span class="k">while</span> <span class="n">totx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pe2</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">te2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
                <span class="n">tp2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
                <span class="n">h2</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>
                <span class="n">tdef3</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">,</span> <span class="n">tp3</span><span class="p">)</span> <span class="o">-</span> <span class="n">te3</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te3</span><span class="p">)</span>
                <span class="n">tdef2</span> <span class="o">=</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">,</span> <span class="n">tp2</span><span class="p">)</span> <span class="o">-</span> <span class="n">te2</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te2</span><span class="p">)</span>
                <span class="n">lyrf</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef3</span> <span class="o">+</span> <span class="n">tdef2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">h2</span> <span class="o">-</span> <span class="n">h3</span><span class="p">)</span>
                <span class="n">totx</span> <span class="o">+=</span> <span class="n">lyrf</span>
                <span class="n">tp3</span> <span class="o">=</span> <span class="n">tp2</span>
                <span class="n">te3</span> <span class="o">=</span> <span class="n">te2</span>
                <span class="n">pe3</span> <span class="o">=</span> <span class="n">pe2</span>
            <span class="n">pcl</span><span class="o">.</span><span class="n">mplpres</span> <span class="o">=</span> <span class="n">pe2</span>
            <span class="n">pcl</span><span class="o">.</span><span class="n">mplhght</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_agl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe2</span><span class="p">))</span>
        
        <span class="c1"># 500 hPa Lifted Index</span>
        <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">500.</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">li5</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">500.</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="mf">500.</span><span class="p">)</span>
            <span class="n">pcl</span><span class="o">.</span><span class="n">li5</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        
        <span class="c1"># 300 hPa Lifted Index</span>
        <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">300.</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">li3</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">300.</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="mf">300.</span><span class="p">)</span>
            <span class="n">pcl</span><span class="o">.</span><span class="n">li3</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    
<span class="c1">#    pcl.bminus = cinh_old</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span><span class="p">):</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">=</span> <span class="n">totp</span>
    
    <span class="c1"># Calculate BRN if available</span>
    <span class="n">bulk_rich</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pcl</span><span class="p">)</span>
    
    <span class="c1"># Save params</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">ptrace</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ptrace</span><span class="p">,</span> <span class="n">ptraces</span><span class="p">))</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">ttrace</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ttrace</span><span class="p">,</span> <span class="n">ttraces</span><span class="p">))</span>

    <span class="c1"># Find minimum buoyancy from Trier et al. 2014, Part 1</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">ptrace</span> <span class="o">&gt;=</span> <span class="mf">500.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">pcl</span><span class="o">.</span><span class="n">ttrace</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">interp</span><span class="o">.</span><span class="n">vtmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pcl</span><span class="o">.</span><span class="n">ptrace</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">bmin</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">bminpres</span> <span class="o">=</span> <span class="n">pcl</span><span class="o">.</span><span class="n">ptrace</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">idx2</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">pcl</span></div>


<div class="viewcode-block" id="bulk_rich"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.bulk_rich">[docs]</a><span class="k">def</span> <span class="nf">bulk_rich</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pcl</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the Bulk Richardson Number for a given parcel.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        pcl : parcel object</span>
<span class="sd">            Parcel object</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Bulk Richardson Number : number</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>

    <span class="c1"># Make sure parcel is initialized</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">lplvals</span><span class="p">):</span>
        <span class="n">pbot</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">elif</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lplvals</span><span class="o">.</span><span class="n">flag</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lplvals</span><span class="o">.</span><span class="n">flag</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">ptop</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">6000.</span><span class="p">))</span>
        <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h0</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pcl</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pbot</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">h0</span><span class="o">-</span><span class="mf">500.</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">pbot</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pbot</span><span class="p">):</span> <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)</span>
        <span class="n">ptop</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">h1</span><span class="o">+</span><span class="mf">6000.</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pbot</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">ptop</span><span class="p">):</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">brnshear</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">brn</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">brnu</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">brnv</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
        <span class="k">return</span> <span class="n">pcl</span>
    
    <span class="c1"># Calculate the lowest 500m mean wind</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)</span><span class="o">+</span><span class="mf">500.</span><span class="p">)</span>
    <span class="c1">#print(p, pbot)</span>
    <span class="n">mnlu</span><span class="p">,</span> <span class="n">mnlv</span> <span class="o">=</span> <span class="n">winds</span><span class="o">.</span><span class="n">mean_wind</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    
    <span class="c1"># Calculate the 6000m mean wind</span>
    <span class="n">mnuu</span><span class="p">,</span> <span class="n">mnuv</span> <span class="o">=</span> <span class="n">winds</span><span class="o">.</span><span class="n">mean_wind</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)</span>
    
    <span class="c1"># Make sure CAPE and Shear are available</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">mnlu</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">mnuu</span><span class="p">):</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">brnshear</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">brnu</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">brnv</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
        <span class="n">pcl</span><span class="o">.</span><span class="n">brn</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
        <span class="k">return</span> <span class="n">pcl</span>
    
    <span class="c1"># Calculate shear between levels</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">mnuu</span> <span class="o">-</span> <span class="n">mnlu</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">mnuv</span> <span class="o">-</span> <span class="n">mnlv</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">brnu</span> <span class="o">=</span> <span class="n">dx</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">brnv</span> <span class="o">=</span> <span class="n">dy</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">brnshear</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">KTS2MS</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">mag</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">))</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">brnshear</span> <span class="o">=</span> <span class="n">pcl</span><span class="o">.</span><span class="n">brnshear</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">pcl</span><span class="o">.</span><span class="n">brn</span> <span class="o">=</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">/</span> <span class="n">pcl</span><span class="o">.</span><span class="n">brnshear</span>
    <span class="k">return</span> <span class="n">pcl</span></div>


<div class="viewcode-block" id="effective_inflow_layer"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.effective_inflow_layer">[docs]</a><span class="k">def</span> <span class="nf">effective_inflow_layer</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ecape</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ecinh</span><span class="o">=-</span><span class="mi">250</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the top and bottom of the effective inflow layer based on</span>
<span class="sd">        research by [3]_.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        ecape : number (optional; default=100)</span>
<span class="sd">            Minimum amount of CAPE in the layer to be considered part of the</span>
<span class="sd">            effective inflow layer.</span>
<span class="sd">        echine : number (optional; default=250)</span>
<span class="sd">            Maximum amount of CINH in the layer to be considered part of the</span>
<span class="sd">            effective inflow layer</span>
<span class="sd">        mupcl : parcel object</span>
<span class="sd">            Most Unstable Layer parcel</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pbot : number</span>
<span class="sd">            Pressure at the bottom of the layer (hPa)</span>
<span class="sd">        ptop : number</span>
<span class="sd">            Pressure at the top of the layer (hPa)</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mupcl</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mupcl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mupcl</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mupcl</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">mupcl</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">mulplvals</span> <span class="o">=</span> <span class="n">DefineParcel</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="n">mupcl</span> <span class="o">=</span> <span class="n">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">lplvals</span><span class="o">=</span><span class="n">mulplvals</span><span class="p">)</span>
    <span class="n">mucape</span>   <span class="o">=</span> <span class="n">mupcl</span><span class="o">.</span><span class="n">bplus</span>
    <span class="n">mucinh</span> <span class="o">=</span> <span class="n">mupcl</span><span class="o">.</span><span class="n">bminus</span>
    <span class="n">pbot</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="n">ptop</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">if</span> <span class="n">mucape</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mucape</span> <span class="o">&gt;=</span> <span class="n">ecape</span> <span class="ow">and</span> <span class="n">mucinh</span> <span class="o">&gt;</span> <span class="n">ecinh</span><span class="p">:</span>
            <span class="c1"># Begin at surface and search upward for effective surface</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">top</span><span class="p">):</span>
                <span class="n">pcl</span> <span class="o">=</span> <span class="n">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tmpc</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dwpc</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">&gt;=</span> <span class="n">ecape</span> <span class="ow">and</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">&gt;</span> <span class="n">ecinh</span><span class="p">:</span>
                    <span class="n">pbot</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pbot</span><span class="p">):</span> 
                <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">,</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>

            <span class="n">bptr</span> <span class="o">=</span> <span class="n">i</span>
            <span class="c1"># Keep searching upward for the effective top</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bptr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">top</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="n">pcl</span> <span class="o">=</span> <span class="n">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tmpc</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dwpc</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">&lt;</span> <span class="n">ecape</span> <span class="ow">or</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">&lt;=</span> <span class="n">ecinh</span><span class="p">:</span> <span class="c1">#Is this a potential &quot;top&quot;?</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">]):</span>
                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">ptop</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ptop</span> <span class="o">&gt;</span> <span class="n">pbot</span><span class="p">:</span> <span class="n">ptop</span> <span class="o">=</span> <span class="n">pbot</span>
                    <span class="k">break</span>

    <span class="k">return</span> <span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span></div>

<span class="k">def</span> <span class="nf">_binary_cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ibot</span><span class="p">,</span> <span class="n">itop</span><span class="p">,</span> <span class="n">ecape</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ecinh</span><span class="o">=-</span><span class="mi">250</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ibot</span> <span class="o">==</span> <span class="n">itop</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">ibot</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">ibot</span> <span class="o">==</span> <span class="n">itop</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pcl</span> <span class="o">=</span> <span class="n">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">ibot</span><span class="p">],</span> <span class="n">tmpc</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="n">ibot</span><span class="p">],</span> <span class="n">dwpc</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="n">ibot</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">&lt;</span> <span class="n">ecape</span> <span class="ow">or</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">&lt;=</span> <span class="n">ecinh</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">ibot</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">itop</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">ibot</span> <span class="o">+</span> <span class="p">(</span><span class="n">itop</span> <span class="o">-</span> <span class="n">ibot</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">pcl</span> <span class="o">=</span> <span class="n">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tmpc</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dwpc</span><span class="o">=</span><span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">&lt;</span> <span class="n">ecape</span> <span class="ow">or</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">&lt;=</span> <span class="n">ecinh</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_binary_cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ibot</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ecape</span><span class="o">=</span><span class="n">ecape</span><span class="p">,</span> <span class="n">ecinh</span><span class="o">=</span><span class="n">ecinh</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_binary_cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">itop</span><span class="p">,</span> <span class="n">ecape</span><span class="o">=</span><span class="n">ecape</span><span class="p">,</span> <span class="n">ecinh</span><span class="o">=</span><span class="n">ecinh</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">effective_inflow_layer_binary</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ecape</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ecinh</span><span class="o">=-</span><span class="mi">250</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the top and bottom of the effective inflow layer based on</span>
<span class="sd">        research by [3]_.  Uses a binary search.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        ecape : number (optional; default=100)</span>
<span class="sd">            Minimum amount of CAPE in the layer to be considered part of the</span>
<span class="sd">            effective inflow layer.</span>
<span class="sd">        echine : number (optional; default=250)</span>
<span class="sd">            Maximum amount of CINH in the layer to be considered part of the</span>
<span class="sd">            effective inflow layer</span>
<span class="sd">        mupcl : parcel object</span>
<span class="sd">            Most Unstable Layer parcel</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pbot : number</span>
<span class="sd">            Pressure at the bottom of the layer (hPa)</span>
<span class="sd">        ptop : number</span>
<span class="sd">            Pressure at the top of the layer (hPa)</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mupcl</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mupcl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mupcl</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mupcl</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">mupcl</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">mulplvals</span> <span class="o">=</span> <span class="n">DefineParcel</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="n">mupcl</span> <span class="o">=</span> <span class="n">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">lplvals</span><span class="o">=</span><span class="n">mulplvals</span><span class="p">)</span>
    <span class="n">mucape</span> <span class="o">=</span> <span class="n">mupcl</span><span class="o">.</span><span class="n">bplus</span>
    <span class="n">mucinh</span> <span class="o">=</span> <span class="n">mupcl</span><span class="o">.</span><span class="n">bminus</span>
    <span class="n">pbot</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="n">ptop</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">if</span> <span class="n">mucape</span> <span class="o">&gt;=</span> <span class="n">ecape</span> <span class="ow">and</span> <span class="n">mucinh</span> <span class="o">&gt;</span> <span class="n">ecinh</span><span class="p">:</span>
        <span class="n">istart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mupcl</span><span class="o">.</span><span class="n">lplvals</span><span class="o">.</span><span class="n">pres</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">))</span>
        <span class="n">itop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">300</span> <span class="o">-</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">))</span>

        <span class="n">pbot</span> <span class="o">=</span> <span class="n">_binary_cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">istart</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">,</span> <span class="n">ecape</span><span class="o">=</span><span class="n">ecape</span><span class="p">,</span> <span class="n">ecinh</span><span class="o">=</span><span class="n">ecinh</span><span class="p">)</span>
        <span class="n">ptop</span> <span class="o">=</span> <span class="n">_binary_cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">istart</span><span class="p">,</span> <span class="n">itop</span><span class="p">,</span> <span class="n">ecape</span><span class="o">=</span><span class="n">ecape</span><span class="p">,</span> <span class="n">ecinh</span><span class="o">=</span><span class="n">ecinh</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span>

<div class="viewcode-block" id="bunkers_storm_motion"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.bunkers_storm_motion">[docs]</a><span class="k">def</span> <span class="nf">bunkers_storm_motion</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the Bunkers Storm Motion for a right moving supercell using a</span>
<span class="sd">        parcel based approach. This code is consistent with the findings in</span>
<span class="sd">        Bunkers et. al 2014, using the Effective Inflow Base as the base, and</span>
<span class="sd">        65% of the most unstable parcel equilibrium level height using the</span>
<span class="sd">        pressure weighted mean wind.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        pbot : float (optional)</span>
<span class="sd">            Base of effective-inflow layer (hPa)</span>
<span class="sd">        mupcl : parcel object (optional)</span>
<span class="sd">            Most Unstable Layer parcel</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rstu : number</span>
<span class="sd">            Right Storm Motion U-component (kts)</span>
<span class="sd">        rstv : number</span>
<span class="sd">            Right Storm Motion V-component (kts)</span>
<span class="sd">        lstu : number</span>
<span class="sd">            Left Storm Motion U-component (kts)</span>
<span class="sd">        lstv : number</span>
<span class="sd">            Left Storm Motion V-component (kts)</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">MS2KTS</span><span class="p">(</span><span class="mf">7.5</span><span class="p">)</span>   <span class="c1"># Deviation value emperically derived at 7.5 m/s</span>
    <span class="n">mupcl</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mupcl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">pbot</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pbot&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mupcl</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mupcl</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">mupcl</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">mulplvals</span> <span class="o">=</span> <span class="n">DefineParcel</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
            <span class="n">mupcl</span> <span class="o">=</span> <span class="n">parcelx</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">lplvals</span><span class="o">=</span><span class="n">mulplvals</span><span class="p">)</span>
    <span class="n">mucape</span> <span class="o">=</span> <span class="n">mupcl</span><span class="o">.</span><span class="n">bplus</span>
    <span class="n">mucinh</span> <span class="o">=</span> <span class="n">mupcl</span><span class="o">.</span><span class="n">bminus</span>
    <span class="n">muel</span> <span class="o">=</span> <span class="n">mupcl</span><span class="o">.</span><span class="n">elhght</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pbot</span><span class="p">:</span>
        <span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span> <span class="o">=</span> <span class="n">effective_inflow_layer</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">250</span><span class="p">,</span> <span class="n">mupcl</span><span class="o">=</span><span class="n">mupcl</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_agl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">mucape</span> <span class="o">&gt;</span> <span class="mf">100.</span> <span class="ow">and</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">muel</span><span class="p">):</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">muel</span> <span class="o">-</span> <span class="n">base</span>
        <span class="n">htop</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span> <span class="n">depth</span> <span class="o">*</span> <span class="p">(</span><span class="mf">65.</span><span class="o">/</span><span class="mf">100.</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">ptop</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">htop</span><span class="p">))</span>
        <span class="n">mnu</span><span class="p">,</span> <span class="n">mnv</span> <span class="o">=</span> <span class="n">winds</span><span class="o">.</span><span class="n">mean_wind</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)</span>
        <span class="n">sru</span><span class="p">,</span> <span class="n">srv</span> <span class="o">=</span> <span class="n">winds</span><span class="o">.</span><span class="n">wind_shear</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="p">)</span>
        <span class="n">srmag</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mag</span><span class="p">(</span><span class="n">sru</span><span class="p">,</span> <span class="n">srv</span><span class="p">)</span>
        <span class="n">uchg</span> <span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="n">srmag</span> <span class="o">*</span> <span class="n">srv</span>
        <span class="n">vchg</span> <span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="n">srmag</span> <span class="o">*</span> <span class="n">sru</span>
        <span class="n">rstu</span> <span class="o">=</span> <span class="n">mnu</span> <span class="o">+</span> <span class="n">uchg</span>
        <span class="n">rstv</span> <span class="o">=</span> <span class="n">mnv</span> <span class="o">-</span> <span class="n">vchg</span>
        <span class="n">lstu</span> <span class="o">=</span> <span class="n">mnu</span> <span class="o">-</span> <span class="n">uchg</span>
        <span class="n">lstv</span> <span class="o">=</span> <span class="n">mnv</span> <span class="o">+</span> <span class="n">vchg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rstu</span><span class="p">,</span> <span class="n">rstv</span><span class="p">,</span> <span class="n">lstu</span><span class="p">,</span> <span class="n">lstv</span> <span class="o">=</span> <span class="n">winds</span><span class="o">.</span><span class="n">non_parcel_bunkers_motion</span><span class="p">(</span><span class="n">prof</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">rstu</span><span class="p">,</span> <span class="n">rstv</span><span class="p">,</span> <span class="n">lstu</span><span class="p">,</span> <span class="n">lstv</span></div>


<div class="viewcode-block" id="convective_temp"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.convective_temp">[docs]</a><span class="k">def</span> <span class="nf">convective_temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the convective temperature, assuming no change in the moisture</span>
<span class="sd">        profile. Parcels are iteratively lifted until only mincinh is left as a</span>
<span class="sd">        cap. The first guess is the observed surface temperature.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile Object</span>
<span class="sd">        mincinh : parcel object (optional; default -1)</span>
<span class="sd">            Amount of CINH left at CI</span>
<span class="sd">        pres : number (optional)</span>
<span class="sd">            Pressure of parcel to lift (hPa)</span>
<span class="sd">        tmpc : number (optional)</span>
<span class="sd">            Temperature of parcel to lift (C)</span>
<span class="sd">        dwpc : number (optional)</span>
<span class="sd">            Dew Point of parcel to lift (C)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Convective Temperature (C) : number</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="n">mincinh</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mincinh&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">mmr</span> <span class="o">=</span> <span class="n">mean_mixratio</span><span class="p">(</span><span class="n">prof</span><span class="p">)</span>
    <span class="n">pres</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pres&#39;</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">])</span>
    <span class="n">tmpc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tmpc&#39;</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">])</span>
    <span class="n">dwpc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dwpc&#39;</span><span class="p">,</span> <span class="n">thermo</span><span class="o">.</span><span class="n">temp_at_mixrat</span><span class="p">(</span><span class="n">mmr</span><span class="p">,</span> <span class="n">pres</span><span class="p">))</span>
    
    <span class="c1"># Do a quick search to fine whether to continue. If you need to heat</span>
    <span class="c1"># up more than 25C, don&#39;t compute.</span>
    <span class="n">pcl</span> <span class="o">=</span> <span class="n">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="n">pres</span><span class="p">,</span> <span class="n">tmpc</span><span class="o">=</span><span class="n">tmpc</span><span class="o">+</span><span class="mf">25.</span><span class="p">,</span> <span class="n">dwpc</span><span class="o">=</span><span class="n">dwpc</span><span class="p">,</span> <span class="n">trunc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">==</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">&lt;</span> <span class="n">mincinh</span><span class="p">:</span> <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">dwpc</span> <span class="o">-</span> <span class="n">tmpc</span>
    <span class="k">if</span> <span class="n">excess</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">tmpc</span> <span class="o">=</span> <span class="n">tmpc</span> <span class="o">+</span> <span class="n">excess</span> <span class="o">+</span> <span class="mf">4.</span>
    <span class="n">pcl</span> <span class="o">=</span> <span class="n">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="n">pres</span><span class="p">,</span> <span class="n">tmpc</span><span class="o">=</span><span class="n">tmpc</span><span class="p">,</span> <span class="n">dwpc</span><span class="o">=</span><span class="n">dwpc</span><span class="p">,</span> <span class="n">trunc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">==</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span><span class="p">):</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">&lt;</span> <span class="n">mincinh</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">100</span><span class="p">:</span> <span class="n">tmpc</span> <span class="o">+=</span> <span class="mf">2.</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">tmpc</span> <span class="o">+=</span> <span class="mf">0.5</span>
        <span class="n">pcl</span> <span class="o">=</span> <span class="n">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="n">pres</span><span class="p">,</span> <span class="n">tmpc</span><span class="o">=</span><span class="n">tmpc</span><span class="p">,</span> <span class="n">dwpc</span><span class="o">=</span><span class="n">dwpc</span><span class="p">,</span> <span class="n">trunc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bminus</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">return</span> <span class="n">tmpc</span></div>

<div class="viewcode-block" id="tei"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.tei">[docs]</a><span class="k">def</span> <span class="nf">tei</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Theta-E Index (TEI)</span>
<span class="sd">        TEI is the difference between the surface theta-e and the minimum theta-e value</span>
<span class="sd">        in the lowest 400 mb AGL</span>
<span class="sd">       </span>
<span class="sd">        Note: This is the definition of TEI on the SPC help page,</span>
<span class="sd">        but these calculations do not match up with the TEI values on the SPC Online Soundings.</span>
<span class="sd">        The TEI values online are more consistent with the max Theta-E</span>
<span class="sd">        minus the minimum Theta-E found in the lowest 400 mb AGL.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tei : number</span>
<span class="sd">            Theta-E Index</span>
<span class="sd">        &#39;&#39;&#39;</span>
    
    <span class="n">sfc_theta</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">thetae</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="n">sfc_pres</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="n">top_pres</span> <span class="o">=</span> <span class="n">sfc_pres</span> <span class="o">-</span> <span class="mf">400.</span>
    
    <span class="n">layer_idxs</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span> <span class="o">&gt;=</span> <span class="n">top_pres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">min_thetae</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">thetae</span><span class="p">[</span><span class="n">layer_idxs</span><span class="p">])</span>
    <span class="n">max_thetae</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">thetae</span><span class="p">[</span><span class="n">layer_idxs</span><span class="p">])</span>

    <span class="c1">#tei = sfc_theta - min_thetae</span>
    <span class="n">tei</span> <span class="o">=</span> <span class="n">max_thetae</span> <span class="o">-</span> <span class="n">min_thetae</span>
    <span class="k">return</span> <span class="n">tei</span></div>

<div class="viewcode-block" id="esp"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.esp">[docs]</a><span class="k">def</span> <span class="nf">esp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Enhanced Stretching Potential (ESP)</span>
<span class="sd">        This composite parameter identifies areas where low-level buoyancy</span>
<span class="sd">        and steep low-level lapse rates are co-located, which may</span>
<span class="sd">        favor low-level vortex stretching and tornado potential.</span>
<span class="sd">       </span>
<span class="sd">        REQUIRES: 0-3 km MLCAPE (from MLPCL)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        mlpcl : parcel object, optional</span>
<span class="sd">            Mixed-Layer Parcel object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ESP Index : number</span>
<span class="sd">        &#39;&#39;&#39;</span>
     
    <span class="n">mlpcl</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mlpcl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlpcl</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mlpcl</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">mlpcl</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">mlpcl</span> <span class="o">=</span> <span class="n">parcelx</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">mlcape</span> <span class="o">=</span> <span class="n">mlpcl</span><span class="o">.</span><span class="n">b3km</span>
    
    <span class="n">lr03</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">lapserate_3km</span> <span class="c1"># C/km</span>
    <span class="k">if</span> <span class="n">lr03</span> <span class="o">&lt;</span> <span class="mf">7.</span> <span class="ow">or</span> <span class="n">mlpcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">&lt;</span> <span class="mf">250.</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">esp</span> <span class="o">=</span> <span class="p">(</span><span class="n">mlcape</span> <span class="o">/</span> <span class="mf">50.</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">lr03</span> <span class="o">-</span> <span class="mf">7.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">esp</span></div>

<div class="viewcode-block" id="sherb"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.sherb">[docs]</a><span class="k">def</span> <span class="nf">sherb</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Severe Hazards In Environments with Reduced Buoyancy (SHERB) Parameter (*)</span>

<span class="sd">        A composite parameter designed to assist forecasters in the High-Shear</span>
<span class="sd">        Low CAPE (HSLC) environment.  This allows better discrimination </span>
<span class="sd">        between significant severe and non-severe convection in HSLC enviroments.</span>

<span class="sd">        It can detect significant tornadoes and significant winds.  Values above</span>
<span class="sd">        1 are more likely associated with significant severe.</span>

<span class="sd">        See Sherburn et. al. 2014 WAF for more information</span>

<span class="sd">        REQUIRES (if effective==True): The effective inflow layer be defined</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This function has not been evaluated or tested against the version used at SPC.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        effective : bool, optional</span>
<span class="sd">            Use the effective layer computation or not</span>
<span class="sd">            the effective bulk wind difference (prof.ebwd) must exist first</span>
<span class="sd">            if not specified it will (Default is False)</span>
<span class="sd">        ebottom : number, optional</span>
<span class="sd">            bottom of the effective inflow layer (mb)</span>
<span class="sd">        etop : number, optional</span>
<span class="sd">            top of the effective inflow layer (mb)</span>
<span class="sd">        mupcl : parcel object, optional</span>
<span class="sd">            Most-Unstable Parcel</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SHERB : number</span>

<span class="sd">        &#39;&#39;&#39;</span>

    <span class="n">effective</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;effective&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">ebottom</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ebottom&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">etop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;etop&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">lr03</span> <span class="o">=</span> <span class="n">lapse_rate</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lr75</span> <span class="o">=</span> <span class="n">lapse_rate</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">effective</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">p3km</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mi">3000</span><span class="p">))</span>
        <span class="n">sfc_pres</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">get_sfc</span><span class="p">()]</span>
        <span class="n">shear</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">KTS2MS</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">mag</span><span class="p">(</span><span class="o">*</span><span class="n">winds</span><span class="o">.</span><span class="n">wind_shear</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">sfc_pres</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">p3km</span><span class="p">)))</span>
        <span class="n">sherb</span> <span class="o">=</span> <span class="p">(</span> <span class="n">shear</span> <span class="o">/</span> <span class="mf">26.</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">lr03</span> <span class="o">/</span> <span class="mf">5.2</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">lr75</span> <span class="o">/</span> <span class="mf">5.6</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;ebwd&#39;</span><span class="p">):</span>
            <span class="c1"># If the Profile object has the attribute &quot;ebwd&quot;</span>
            <span class="n">shear</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">KTS2MS</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">mag</span><span class="p">(</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebwd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebwd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">))</span>

        <span class="k">elif</span> <span class="p">((</span><span class="ow">not</span> <span class="n">ebottom</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">etop</span><span class="p">))</span> <span class="ow">or</span> \
             <span class="p">((</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;ebottom&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;etop&#39;</span><span class="p">))):</span>
            <span class="c1"># if the effective inflow layer hasn&#39;t been specified via the function arguments</span>
            <span class="c1"># or doesn&#39;t exist in the Profile object we need to calculate it, but we need mupcl</span>
            <span class="k">if</span> <span class="n">ebottom</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">etop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">#only calculate ebottom and etop if they&#39;re not supplied by the kwargs</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;mupcl&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mupcl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="c1"># If the mupcl attribute doesn&#39;t exist in the Profile</span>
                    <span class="c1"># or the mupcl hasn&#39;t been passed as an argument</span>
                    <span class="c1"># compute the mupcl</span>
                    <span class="n">mulplvals</span> <span class="o">=</span> <span class="n">DefineParcel</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                    <span class="n">mupcl</span> <span class="o">=</span> <span class="n">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">lplvals</span><span class="o">=</span><span class="n">mulplvals</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mupcl</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">mupcl</span>
           
                <span class="c1"># Calculate the effective inflow layer</span>
                <span class="n">ebottom</span><span class="p">,</span> <span class="n">etop</span> <span class="o">=</span> <span class="n">effective_inflow_layer</span><span class="p">(</span> <span class="n">prof</span><span class="p">,</span> <span class="n">mupcl</span><span class="o">=</span><span class="n">mupcl</span> <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">ebottom</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">masked</span> <span class="ow">or</span> <span class="n">etop</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">masked</span><span class="p">:</span>
                <span class="c1"># If the inflow layer doesn&#39;t exist, return missing</span>
                <span class="k">return</span> <span class="n">prof</span><span class="o">.</span><span class="n">missing</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Calculate the Effective Bulk Wind Difference</span>
                <span class="n">ebotm</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_agl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ebottom</span><span class="p">))</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span> <span class="n">mupcl</span><span class="o">.</span><span class="n">elhght</span> <span class="o">-</span> <span class="n">ebotm</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">elh</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">ebotm</span> <span class="o">+</span> <span class="n">depth</span><span class="p">))</span>
                <span class="n">ebwd</span> <span class="o">=</span> <span class="n">winds</span><span class="o">.</span><span class="n">wind_shear</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">ebottom</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">elh</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If there&#39;s no way to compute the effective SHERB</span>
            <span class="c1"># because there&#39;s no information about how to get the</span>
            <span class="c1"># inflow layer, return missing.</span>
            <span class="k">return</span> <span class="n">prof</span><span class="o">.</span><span class="n">missing</span>
        <span class="n">shear</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">KTS2MS</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">mag</span><span class="p">(</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebwd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebwd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">))</span>
        <span class="n">sherb</span> <span class="o">=</span> <span class="p">(</span> <span class="n">shear</span> <span class="o">/</span> <span class="mf">27.</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">lr03</span> <span class="o">/</span> <span class="mf">5.2</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">lr75</span> <span class="o">/</span> <span class="mf">5.6</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">sherb</span></div>

<div class="viewcode-block" id="mmp"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.mmp">[docs]</a><span class="k">def</span> <span class="nf">mmp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MCS Maintenance Probability (MMP)</span>
<span class="sd">        The probability that a mature MCS will maintain peak intensity</span>
<span class="sd">        for the next hour.</span>
<span class="sd">        </span>
<span class="sd">        This equation was developed using proximity soundings and a regression equation</span>
<span class="sd">        Uses MUCAPE, 3-8 km lapse rate, maximum bulk shear, 3-12 km mean wind speed.  Derived</span>
<span class="sd">        in [4]_.</span>

<span class="sd">        .. [4] Coniglio, M. C., D. J. Stensrud, and L. J. Wicker, 2006: Effects of upper-level shear on the structure and maintenance of strong quasi-linear mesoscale convective systems. J. Atmos. Sci., 63, 12311251, doi:https://doi.org/10.1175/JAS3681.1.</span>

<span class="sd">        Note:</span>
<span class="sd">        Per Mike Coniglio (personal comm.), the maximum deep shear value is computed by</span>
<span class="sd">        computing the shear vector between all the wind vectors</span>
<span class="sd">        in the lowest 1 km and all the wind vectors in the 6-10 km layer.</span>
<span class="sd">        The maximum speed shear from this is the max_bulk_shear value (m/s).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        mupcl : parcel object, optional</span>
<span class="sd">            Most-Unstable Parcel object</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        MMP index (%): number</span>
<span class="sd">        </span>

<span class="sd">        &quot;&quot;&quot;</span>
    
    <span class="n">mupcl</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mupcl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mupcl</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mupcl</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">mupcl</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">mulplvals</span> <span class="o">=</span> <span class="n">DefineParcel</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="n">mupcl</span> <span class="o">=</span> <span class="n">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">lplvals</span><span class="o">=</span><span class="n">mulplvals</span><span class="p">)</span>
    <span class="n">mucape</span> <span class="o">=</span> <span class="n">mupcl</span><span class="o">.</span><span class="n">bplus</span>

    <span class="k">if</span> <span class="n">mucape</span> <span class="o">&lt;</span> <span class="mf">100.</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.</span>

    <span class="n">agl_hght</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_agl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">hght</span><span class="p">)</span>
    <span class="n">lowest_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">agl_hght</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">highest_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">agl_hght</span> <span class="o">&gt;=</span> <span class="mi">6000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">agl_hght</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lowest_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">highest_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="n">possible_shears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">lowest_idx</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">highest_idx</span><span class="p">)))</span>
    <span class="n">pbots</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">hght</span><span class="p">[</span><span class="n">lowest_idx</span><span class="p">])</span>
    <span class="n">ptops</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">hght</span><span class="p">[</span><span class="n">highest_idx</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lowest_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">highest_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>

    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pbots</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ptops</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">u_shear</span><span class="p">,</span> <span class="n">v_shear</span> <span class="o">=</span> <span class="n">winds</span><span class="o">.</span><span class="n">wind_shear</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">pbots</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">ptop</span><span class="o">=</span><span class="n">ptops</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
            <span class="n">possible_shears</span><span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mag</span><span class="p">(</span><span class="n">u_shear</span><span class="p">,</span> <span class="n">v_shear</span><span class="p">)</span>
    <span class="n">max_bulk_shear</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">KTS2MS</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">possible_shears</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
    <span class="n">lr38</span> <span class="o">=</span> <span class="n">lapse_rate</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">3000.</span><span class="p">,</span> <span class="mf">8000.</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plower</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">3000.</span><span class="p">))</span>
    <span class="n">pupper</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">12000.</span><span class="p">))</span>
    <span class="n">mean_wind_3t12</span> <span class="o">=</span> <span class="n">winds</span><span class="o">.</span><span class="n">mean_wind</span><span class="p">(</span> <span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">plower</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">pupper</span><span class="p">)</span>
    <span class="n">mean_wind_3t12</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">KTS2MS</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">mag</span><span class="p">(</span><span class="n">mean_wind_3t12</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mean_wind_3t12</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">a_0</span> <span class="o">=</span> <span class="mf">13.0</span> <span class="c1"># unitless</span>
    <span class="n">a_1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.59</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">2</span> <span class="c1"># m**-1 * s</span>
    <span class="n">a_2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.16</span> <span class="c1"># K**-1 * km</span>
    <span class="n">a_3</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.17</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">4</span> <span class="c1"># J**-1 * kg</span>
    <span class="n">a_4</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.17</span> <span class="c1"># m**-1 * s</span>
    
    <span class="n">mmp</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">a_1</span> <span class="o">*</span> <span class="n">max_bulk_shear</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">a_2</span> <span class="o">*</span> <span class="n">lr38</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">a_3</span> <span class="o">*</span> <span class="n">mucape</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">a_4</span> <span class="o">*</span> <span class="n">mean_wind_3t12</span><span class="p">)))</span>
    
    <span class="k">return</span> <span class="n">mmp</span></div>

<div class="viewcode-block" id="wndg"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.wndg">[docs]</a><span class="k">def</span> <span class="nf">wndg</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wind Damage Parameter (WNDG)</span>

<span class="sd">        A non-dimensional composite parameter that identifies areas</span>
<span class="sd">        where large CAPE, steep low-level lapse rates,</span>
<span class="sd">        enhanced flow in the low-mid levels, and minimal convective</span>
<span class="sd">        inhibition are co-located.</span>
<span class="sd">        </span>
<span class="sd">        WNDG values &gt; 1 favor an enhanced risk for scattered damaging</span>
<span class="sd">        outflow gusts with multicell thunderstorm clusters, primarily</span>
<span class="sd">        during the afternoon in the summer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        mlpcl : parcel object, optional</span>
<span class="sd">            Mixed-Layer Parcel object (optional)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        WNDG Index : number</span>

<span class="sd">        &#39;&#39;&#39;</span>
    
    <span class="n">mlpcl</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mlpcl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlpcl</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mlpcl</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">mlpcl</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">mllplvals</span> <span class="o">=</span> <span class="n">DefineParcel</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">mlpcl</span> <span class="o">=</span> <span class="n">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">lplvals</span><span class="o">=</span><span class="n">mllplvals</span><span class="p">)</span>
    <span class="n">mlcape</span> <span class="o">=</span> <span class="n">mlpcl</span><span class="o">.</span><span class="n">bplus</span>

    <span class="n">lr03</span> <span class="o">=</span> <span class="n">lapse_rate</span><span class="p">(</span> <span class="n">prof</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">3000.</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span> <span class="c1"># C/km</span>
    <span class="n">bot</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span> <span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span> <span class="n">prof</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">top</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span> <span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span> <span class="n">prof</span><span class="p">,</span> <span class="mf">3500.</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">mean_wind</span> <span class="o">=</span> <span class="n">winds</span><span class="o">.</span><span class="n">mean_wind</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">bot</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">top</span><span class="p">)</span> <span class="c1"># needs to be in m/s</span>
    <span class="n">mean_wind</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">KTS2MS</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">mag</span><span class="p">(</span><span class="n">mean_wind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mean_wind</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">mlcin</span> <span class="o">=</span> <span class="n">mlpcl</span><span class="o">.</span><span class="n">bminus</span> <span class="c1"># J/kg</span>
    
    <span class="k">if</span> <span class="n">lr03</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">lr03</span> <span class="o">=</span> <span class="mf">0.</span>
    
    <span class="k">if</span> <span class="n">mlcin</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">50</span><span class="p">:</span>
        <span class="n">mlcin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">50.</span>
    <span class="n">wndg</span> <span class="o">=</span> <span class="p">(</span><span class="n">mlcape</span> <span class="o">/</span> <span class="mf">2000.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">lr03</span> <span class="o">/</span> <span class="mf">9.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">mean_wind</span> <span class="o">/</span> <span class="mf">15.</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mf">50.</span> <span class="o">+</span> <span class="n">mlcin</span><span class="p">)</span><span class="o">/</span><span class="mf">40.</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">wndg</span></div>


<div class="viewcode-block" id="sig_severe"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.sig_severe">[docs]</a><span class="k">def</span> <span class="nf">sig_severe</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Significant Severe (SigSevere)</span>
<span class="sd">        Craven and Brooks, 2004</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        mlpcl : parcel object, optional</span>
<span class="sd">            Mixed-Layer Parcel object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        significant severe parameter (m3/s3) : number</span>
<span class="sd">    &#39;&#39;&#39;</span>
     
    <span class="n">mlpcl</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mlpcl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">sfc6shr</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sfc6shr&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mlpcl</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mlpcl</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">mlpcl</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">mllplvals</span> <span class="o">=</span> <span class="n">DefineParcel</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">mlpcl</span> <span class="o">=</span> <span class="n">cape</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">lplvals</span><span class="o">=</span><span class="n">mllplvals</span><span class="p">)</span>
    <span class="n">mlcape</span> <span class="o">=</span> <span class="n">mlpcl</span><span class="o">.</span><span class="n">bplus</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">sfc6shr</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sfc_6km_shear</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">sfc_6km_shear</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sfc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
            <span class="n">p6km</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">6000.</span><span class="p">))</span>
            <span class="n">sfc_6km_shear</span> <span class="o">=</span> <span class="n">winds</span><span class="o">.</span><span class="n">wind_shear</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">sfc</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">p6km</span><span class="p">)</span>

    <span class="n">sfc_6km_shear</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mag</span><span class="p">(</span><span class="n">sfc_6km_shear</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sfc_6km_shear</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">shr06</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">KTS2MS</span><span class="p">(</span><span class="n">sfc_6km_shear</span><span class="p">)</span>
    
    <span class="n">sigsevere</span> <span class="o">=</span> <span class="n">mlcape</span> <span class="o">*</span> <span class="n">shr06</span>
    <span class="k">return</span> <span class="n">sigsevere</span></div>

<div class="viewcode-block" id="dcape"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.dcape">[docs]</a><span class="k">def</span> <span class="nf">dcape</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Downdraft CAPE (DCAPE)</span>
<span class="sd">        </span>
<span class="sd">        Adapted from John Hart&#39;s (SPC) DCAPE code in NSHARP donated by Rich Thompson (SPC)</span>

<span class="sd">        Calculates the downdraft CAPE value using the downdraft parcel source found in the lowest</span>
<span class="sd">        400 mb of the sounding.  This downdraft parcel is found by identifying the minimum 100 mb layer </span>
<span class="sd">        averaged Theta-E.</span>

<span class="sd">        Afterwards, this parcel is lowered to the surface moist adiabatically (w/o virtual temperature</span>
<span class="sd">        correction) and the energy accumulated is called the DCAPE.</span>

<span class="sd">		Future adaptations of this function may utilize the Parcel/DefineParcel object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dcape : number</span>
<span class="sd">            downdraft CAPE (J/kg)</span>
<span class="sd">        ttrace : array</span>
<span class="sd">            downdraft parcel trace temperature (C)</span>
<span class="sd">        ptrace : array</span>
<span class="sd">            downdraft parcel trace pressure (mb)</span>
<span class="sd">        &#39;&#39;&#39;</span>
    
    <span class="n">sfc_pres</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="n">prof_thetae</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">thetae</span>
    <span class="n">prof_wetbulb</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">wetbulb</span>
    <span class="n">mask1</span> <span class="o">=</span> <span class="n">prof_thetae</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">mask2</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span> <span class="p">)</span>
    <span class="n">prof_thetae</span> <span class="o">=</span> <span class="n">prof_thetae</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">prof_wetbulb</span> <span class="o">=</span> <span class="n">prof_wetbulb</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">pres</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">hght</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">hght</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">dwpc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">tmpc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pres</span> <span class="o">&gt;=</span> <span class="n">sfc_pres</span> <span class="o">-</span> <span class="mf">400.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Find the minimum average theta-e in a 100 mb layer</span>
    <span class="n">mine</span> <span class="o">=</span> <span class="mf">1000.0</span>
    <span class="n">minp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
        <span class="n">thta_e_mean</span> <span class="o">=</span> <span class="n">mean_thetae</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">pres</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ptop</span><span class="o">=</span><span class="n">pres</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mf">100.</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">thta_e_mean</span><span class="p">)</span> <span class="ow">and</span> <span class="n">thta_e_mean</span> <span class="o">&lt;</span> <span class="n">mine</span><span class="p">:</span>
            <span class="n">minp</span> <span class="o">=</span> <span class="n">pres</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">50.</span>
            <span class="n">mine</span> <span class="o">=</span> <span class="n">thta_e_mean</span>

    <span class="n">upper</span> <span class="o">=</span> <span class="n">minp</span>
    <span class="n">uptr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pres</span> <span class="o">&gt;=</span> <span class="n">upper</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">uptr</span> <span class="o">=</span> <span class="n">uptr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Define parcel starting point</span>
    <span class="n">tp1</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetbulb</span><span class="p">(</span><span class="n">upper</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">upper</span><span class="p">))</span>
    <span class="n">pe1</span> <span class="o">=</span> <span class="n">upper</span>
    <span class="n">te1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">temp</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe1</span><span class="p">)</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">hght</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pe1</span><span class="p">)</span>
    <span class="n">tote</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lyre</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># To keep track of the parcel trace from the downdraft</span>
    <span class="n">ttrace</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp1</span><span class="p">]</span> 
    <span class="n">ptrace</span> <span class="o">=</span> <span class="p">[</span><span class="n">upper</span><span class="p">]</span>

    <span class="c1"># Lower the parcel to the surface moist adiabatically and compute</span>
    <span class="c1"># total energy (DCAPE)</span>
    <span class="n">iter_ranges</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">uptr</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ttraces</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iter_ranges</span><span class="p">))</span>
    <span class="n">ptraces</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iter_ranges</span><span class="p">))</span>
    <span class="n">ttraces</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ptraces</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iter_ranges</span><span class="p">:</span>
        <span class="n">pe2</span> <span class="o">=</span> <span class="n">pres</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">te2</span> <span class="o">=</span> <span class="n">tmpc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="n">hght</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">tp2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="n">pe2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">te1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">te2</span><span class="p">):</span>
            <span class="n">tdef1</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">te1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te1</span><span class="p">))</span>
            <span class="n">tdef2</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp2</span> <span class="o">-</span> <span class="n">te2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">te2</span><span class="p">))</span>
            <span class="n">lyrlast</span> <span class="o">=</span> <span class="n">lyre</span>
            <span class="n">lyre</span> <span class="o">=</span> <span class="mf">9.8</span> <span class="o">*</span> <span class="p">(</span><span class="n">tdef1</span> <span class="o">+</span> <span class="n">tdef2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">h2</span> <span class="o">-</span> <span class="n">h1</span><span class="p">)</span>
            <span class="n">tote</span> <span class="o">+=</span> <span class="n">lyre</span>

        <span class="n">ttraces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp2</span>
        <span class="n">ptraces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe2</span>

        <span class="n">pe1</span> <span class="o">=</span> <span class="n">pe2</span>
        <span class="n">te1</span> <span class="o">=</span> <span class="n">te2</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="n">h2</span>
        <span class="n">tp1</span> <span class="o">=</span> <span class="n">tp2</span>
    <span class="n">drtemp</span> <span class="o">=</span> <span class="n">tp2</span> <span class="c1"># Downrush temp in Celsius</span>

    <span class="k">return</span> <span class="n">tote</span><span class="p">,</span> <span class="n">ma</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ttrace</span><span class="p">,</span> <span class="n">ttraces</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span> <span class="n">ma</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ptrace</span><span class="p">,</span> <span class="n">ptraces</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span></div>

<div class="viewcode-block" id="precip_eff"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.precip_eff">[docs]</a><span class="k">def</span> <span class="nf">precip_eff</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Precipitation Efficiency (*)</span>

<span class="sd">        This calculation comes from Noel and Dobur 2002, published</span>
<span class="sd">        in NWA Digest Vol 26, No 34.</span>

<span class="sd">        The calculation multiplies the PW from the whole atmosphere</span>
<span class="sd">        by the 1000 - 700 mb mean relative humidity (in decimal form)</span>

<span class="sd">        Values on the SPC Mesoanalysis range from 0 to 2.6.</span>

<span class="sd">        Larger values means that the precipitation is more efficient.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This function has not been directly compared with a version at SPC.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        pwat : number, optional</span>
<span class="sd">            precomputed precipitable water vapor (inch)</span>
<span class="sd">        pbot : number, optional</span>
<span class="sd">            the bottom pressure of the RH layer (mb)</span>
<span class="sd">        ptop : number, optional</span>
<span class="sd">            the top pressure of the RH layer (mb)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        precip_efficency (inches) : number</span>

<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">pw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pwat&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">pbot</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pbot&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">ptop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ptop&#39;</span><span class="p">,</span> <span class="mi">700</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pw</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;pwat&#39;</span><span class="p">):</span>
        <span class="n">pw</span> <span class="o">=</span> <span class="n">precip_water</span><span class="p">(</span><span class="n">prof</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pw</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pwat</span>

    <span class="n">mean_rh</span> <span class="o">=</span> <span class="n">mean_relh</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">pbot</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">ptop</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.</span>

    <span class="k">return</span> <span class="n">pw</span><span class="o">*</span><span class="n">mean_rh</span></div>

<div class="viewcode-block" id="pbl_top"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.pbl_top">[docs]</a><span class="k">def</span> <span class="nf">pbl_top</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Planetary Boundary Layer Depth</span>
<span class="sd">        Adapted from NSHARP code donated by Rich Thompson (SPC)</span>

<span class="sd">        Calculates the planetary boundary layer depth by calculating the </span>
<span class="sd">        virtual potential temperature of the surface parcel + .5 K, and then searching</span>
<span class="sd">        for the location above the surface where the virtual potential temperature of the profile</span>
<span class="sd">        is greater than the surface virtual potential temperature.</span>

<span class="sd">        While this routine suggests a parcel lift, this Python adaptation does not use loop</span>
<span class="sd">        like parcelx().</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ppbl_top (mb) : number</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">thetav</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">,</span> <span class="n">thermo</span><span class="o">.</span><span class="n">virtemp</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">thetav</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span><span class="o">+.</span><span class="mi">5</span> <span class="o">&lt;</span> <span class="n">thetav</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: PBL top could not be found.&quot;</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">thetav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">level</span><span class="p">]</span></div>

<div class="viewcode-block" id="dcp"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.dcp">[docs]</a><span class="k">def</span> <span class="nf">dcp</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Derecho Composite Parameter (*)</span>

<span class="sd">        This parameter is based on a data set of 113 derecho events compiled by Evans and Doswell (2001).</span>
<span class="sd">        The DCP was developed to identify environments considered favorable for cold pool &quot;driven&quot; wind</span>
<span class="sd">        events through four primary mechanisms:</span>

<span class="sd">        1) Cold pool production [DCAPE]</span>
<span class="sd">        2) Ability to sustain strong storms along the leading edge of a gust front [MUCAPE]</span>
<span class="sd">        3) Organization potential for any ensuing convection [0-6 km shear]</span>
<span class="sd">        4) Sufficient flow within the ambient environment to favor development along downstream portion of the gust front [0-6 km mean wind].</span>

<span class="sd">        This index is fomulated as follows:</span>
<span class="sd">        DCP = (DCAPE/980)*(MUCAPE/2000)*(0-6 km shear/20 kt)*(0-6 km mean wind/16 kt)</span>

<span class="sd">        Reference:</span>
<span class="sd">        Evans, J.S., and C.A. Doswell, 2001: Examination of derecho environments using proximity soundings. Wea. Forecasting, 16, 329-342.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dcp : number</span>
<span class="sd">            Derecho Composite Parameter (unitless)</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">sfc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">prof</span><span class="o">.</span><span class="n">sfc</span><span class="p">]</span>
    <span class="n">p6km</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mf">6000.</span><span class="p">))</span>
    <span class="n">dcape_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;dcape&#39;</span><span class="p">,</span> <span class="n">dcape</span><span class="p">(</span> <span class="n">prof</span> <span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mupcl</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;mupcl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mupcl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mupcl</span> <span class="o">=</span> <span class="n">parcelx</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">sfc_6km_shear</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;sfc_6km_shear&#39;</span><span class="p">,</span> <span class="n">winds</span><span class="o">.</span><span class="n">wind_shear</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">sfc</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">p6km</span><span class="p">))</span>
    <span class="n">mean_6km</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;mean_6km&#39;</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">comp2vec</span><span class="p">(</span><span class="o">*</span><span class="n">winds</span><span class="o">.</span><span class="n">mean_wind</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="n">sfc</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="n">p6km</span><span class="p">)))</span>
    <span class="n">mag_shear</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mag</span><span class="p">(</span><span class="n">sfc_6km_shear</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sfc_6km_shear</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">mag_mean_wind</span> <span class="o">=</span> <span class="n">mean_6km</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">dcp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dcape_val</span><span class="o">/</span><span class="mf">980.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">mupcl</span><span class="o">.</span><span class="n">bplus</span><span class="o">/</span><span class="mf">2000.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">mag_shear</span> <span class="o">/</span> <span class="mf">20.</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">mag_mean_wind</span> <span class="o">/</span> <span class="mf">16.</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dcp</span></div>


<div class="viewcode-block" id="mburst"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.mburst">[docs]</a><span class="k">def</span> <span class="nf">mburst</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Microburst Composite Index</span>

<span class="sd">        Formulated by Chad Entremont NWS JAN 12/7/2014</span>
<span class="sd">        Code donated by Rich Thompson (SPC)</span>

<span class="sd">        Below is taken from the SPC Mesoanalysis:</span>
<span class="sd">        The Microburst Composite is a weighted sum of the following individual parameters: SBCAPE, SBLI,</span>
<span class="sd">        lapse rates, vertical totals (850-500 mb temperature difference), DCAPE, and precipitable water.</span>

<span class="sd">        All of the terms are summed to arrive at the final microburst composite value.</span>
<span class="sd">        The values can be interpreted in the following manner: 3-4 infers a &quot;slight chance&quot; of a microburst;</span>
<span class="sd">        5-8 infers a &quot;chance&quot; of a microburst; &gt;= 9 infers that microbursts are &quot;likely&quot;.</span>
<span class="sd">        These values can also be viewed as conditional upon the existence of a storm.</span>
<span class="sd">	</span>
<span class="sd">	    This code was updated on 9/11/2018 - TT was being used in the function instead of VT.</span>
<span class="sd">	    The original SPC code was checked to confirm this was the problem.</span>
<span class="sd">	    This error was not identified during the testing phase for some reason.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mburst : number</span>
<span class="sd">            Microburst Composite (unitless)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">sbpcl</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;sfcpcl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sbpcl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sbpcl</span> <span class="o">=</span> <span class="n">parcelx</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">lr03</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;lapserate_3km&#39;</span><span class="p">,</span> <span class="n">lapse_rate</span><span class="p">(</span> <span class="n">prof</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">3000.</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="kc">False</span> <span class="p">))</span>
    <span class="n">vt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;vertical_totals&#39;</span><span class="p">,</span> <span class="n">v_totals</span><span class="p">(</span><span class="n">prof</span><span class="p">))</span>
    <span class="n">dcape_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;dcape&#39;</span><span class="p">,</span> <span class="n">dcape</span><span class="p">(</span> <span class="n">prof</span> <span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pwat</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;pwat&#39;</span><span class="p">,</span> <span class="n">precip_water</span><span class="p">(</span> <span class="n">prof</span> <span class="p">))</span>
    <span class="n">tei_val</span> <span class="o">=</span> <span class="n">thetae_diff</span><span class="p">(</span><span class="n">prof</span><span class="p">)</span>

    <span class="n">sfc_thetae</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">thetae</span><span class="p">(</span><span class="n">sbpcl</span><span class="o">.</span><span class="n">lplvals</span><span class="o">.</span><span class="n">pres</span><span class="p">,</span> <span class="n">sbpcl</span><span class="o">.</span><span class="n">lplvals</span><span class="o">.</span><span class="n">tmpc</span><span class="p">,</span> <span class="n">sbpcl</span><span class="o">.</span><span class="n">lplvals</span><span class="o">.</span><span class="n">dwpc</span><span class="p">)</span>

    <span class="c1"># SFC Theta-E term</span>
    <span class="k">if</span> <span class="n">thermo</span><span class="o">.</span><span class="n">ctok</span><span class="p">(</span><span class="n">sfc_thetae</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">355</span><span class="p">:</span>
        <span class="n">te</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">te</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Surface-based CAPE Term</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">sbpcl</span><span class="o">.</span><span class="n">bplus</span><span class="p">):</span>
        <span class="n">sbcape_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sbpcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">:</span>
            <span class="n">sbcape_term</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>
        <span class="k">if</span> <span class="n">sbpcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">&gt;=</span> <span class="mi">2000</span><span class="p">:</span>
            <span class="n">sbcape_term</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">sbpcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">&gt;=</span> <span class="mi">3300</span><span class="p">:</span>
            <span class="n">sbcape_term</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">sbpcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">&gt;=</span> <span class="mi">3700</span><span class="p">:</span>
            <span class="n">sbcape_term</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">sbpcl</span><span class="o">.</span><span class="n">bplus</span> <span class="o">&gt;=</span> <span class="mi">4300</span><span class="p">:</span>
            <span class="n">sbcape_term</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="c1"># Surface based LI term</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">sbpcl</span><span class="o">.</span><span class="n">li5</span><span class="p">):</span>
        <span class="n">sbli_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sbpcl</span><span class="o">.</span><span class="n">li5</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">7.5</span><span class="p">:</span>
            <span class="n">sbli_term</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">sbpcl</span><span class="o">.</span><span class="n">li5</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">7.5</span><span class="p">:</span>
            <span class="n">sbli_term</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">sbpcl</span><span class="o">.</span><span class="n">li5</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">9.0</span><span class="p">:</span>
            <span class="n">sbli_term</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">sbpcl</span><span class="o">.</span><span class="n">li5</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">:</span>
            <span class="n">sbli_term</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># PWAT Term</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">pwat</span><span class="p">):</span>
        <span class="n">pwat_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pwat</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">:</span>
            <span class="n">pwat_term</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pwat_term</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># DCAPE Term</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">dcape_val</span><span class="p">):</span>
        <span class="n">dcape_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pwat</span> <span class="o">&gt;</span> <span class="mf">1.70</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dcape_val</span> <span class="o">&gt;</span> <span class="mi">900</span><span class="p">:</span>
                <span class="n">dcape_term</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dcape_term</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dcape_term</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Lapse Rate Term</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">lr03</span><span class="p">):</span>
        <span class="n">lr03_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lr03</span> <span class="o">&lt;=</span> <span class="mf">8.4</span><span class="p">:</span>
            <span class="n">lr03_term</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lr03_term</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Vertical Totals term</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">vt</span><span class="p">):</span>
        <span class="n">vt_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vt</span> <span class="o">&lt;</span> <span class="mi">27</span><span class="p">:</span>
            <span class="n">vt_term</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">vt</span> <span class="o">&gt;=</span> <span class="mi">27</span> <span class="ow">and</span> <span class="n">vt</span> <span class="o">&lt;</span> <span class="mi">28</span><span class="p">:</span>
            <span class="n">vt_term</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">vt</span> <span class="o">&gt;=</span> <span class="mi">28</span> <span class="ow">and</span> <span class="n">vt</span> <span class="o">&lt;</span> <span class="mi">29</span><span class="p">:</span>
            <span class="n">vt_term</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vt_term</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># TEI term?</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">QC</span><span class="p">(</span><span class="n">tei_val</span><span class="p">):</span>
        <span class="n">ted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tei_val</span> <span class="o">&gt;=</span> <span class="mi">35</span><span class="p">:</span>
            <span class="n">ted</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ted</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">mburst</span> <span class="o">=</span> <span class="n">te</span> <span class="o">+</span> <span class="n">sbcape_term</span> <span class="o">+</span> <span class="n">sbli_term</span> <span class="o">+</span> <span class="n">pwat_term</span> <span class="o">+</span> <span class="n">dcape_term</span> <span class="o">+</span> <span class="n">lr03_term</span> <span class="o">+</span> <span class="n">vt_term</span> <span class="o">+</span> <span class="n">ted</span>

    <span class="k">if</span> <span class="n">mburst</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mburst</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mburst</span><span class="p">):</span>
        <span class="n">mburst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>

    <span class="k">return</span> <span class="n">mburst</span></div>

<div class="viewcode-block" id="ehi"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.ehi">[docs]</a><span class="k">def</span> <span class="nf">ehi</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pcl</span><span class="p">,</span> <span class="n">hbot</span><span class="p">,</span> <span class="n">htop</span><span class="p">,</span> <span class="n">stu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stv</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Energy-Helicity Index</span>

<span class="sd">        Computes the energy helicity index (EHI) using a parcel</span>
<span class="sd">        object and a profile object.</span>

<span class="sd">        The equation is EHI = (CAPE * HELICITY) / 160000.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>
<span class="sd">        pcl : parcel object</span>
<span class="sd">            Parcel object</span>
<span class="sd">        hbot : number</span>
<span class="sd">            Height of the bottom of the helicity layer [m]</span>
<span class="sd">        htop : number</span>
<span class="sd">            Height of the top of the helicity layer [m]</span>
<span class="sd">        stu : number</span>
<span class="sd">            Storm-relative wind U component [kts]</span>
<span class="sd">            (optional; default=0)</span>
<span class="sd">        stv : number</span>
<span class="sd">            Storm-relative wind V component [kts]</span>
<span class="sd">            (optional; default=0)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ehi : number</span>
<span class="sd">            Energy Helicity Index (unitless)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">helicity</span> <span class="o">=</span> <span class="n">winds</span><span class="o">.</span><span class="n">helicity</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">hbot</span><span class="p">,</span> <span class="n">htop</span><span class="p">,</span> <span class="n">stu</span><span class="o">=</span><span class="n">stu</span><span class="p">,</span> <span class="n">stv</span><span class="o">=</span><span class="n">stv</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ehi</span> <span class="o">=</span> <span class="p">(</span><span class="n">helicity</span> <span class="o">*</span> <span class="n">pcl</span><span class="o">.</span><span class="n">bplus</span><span class="p">)</span> <span class="o">/</span> <span class="mf">160000.</span>

    <span class="k">return</span> <span class="n">ehi</span></div>

<div class="viewcode-block" id="sweat"><a class="viewcode-back" href="../../../sharppy.sharptab.html#sharppy.sharptab.params.sweat">[docs]</a><span class="k">def</span> <span class="nf">sweat</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SWEAT Index</span>

<span class="sd">        Computes the SWEAT (Severe Weather Threat Index) using the following numbers:</span>

<span class="sd">        1. 850 Dewpoint</span>
<span class="sd">        2. Total Totals Index</span>
<span class="sd">        3. 850 mb wind speed</span>
<span class="sd">        4. 500 mb wind speed</span>
<span class="sd">        5. Direction of wind at 500</span>
<span class="sd">        6. Direction of wind at 850</span>
<span class="sd">	</span>
<span class="sd">	    Formulation taken from Notes on Analysis and Severe-Storm Forecasting Procedures of the Air Force Global Weather Central, 1972 by RC Miller.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This function has not been tested against the SPC version of SHARP.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sweat : number</span>
<span class="sd">            SWEAT Index (number)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">td850</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">dwpt</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mi">850</span><span class="p">)</span>
    <span class="n">vec850</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mi">850</span><span class="p">)</span>
    <span class="n">vec500</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;totals_totals&#39;</span><span class="p">,</span> <span class="n">t_totals</span><span class="p">(</span> <span class="n">prof</span> <span class="p">))</span>

    <span class="k">if</span> <span class="n">td850</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="mf">12.</span> <span class="o">*</span> <span class="n">td850</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="mi">49</span><span class="p">:</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="mf">20.</span> <span class="o">*</span> <span class="p">(</span><span class="n">tt</span> <span class="o">-</span> <span class="mi">49</span><span class="p">)</span>

    <span class="n">term3</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">vec850</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">term4</span> <span class="o">=</span> <span class="n">vec500</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="mi">130</span> <span class="o">&lt;=</span> <span class="n">vec850</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">250</span> <span class="o">&gt;=</span> <span class="n">vec850</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">210</span> <span class="o">&lt;=</span> <span class="n">vec500</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">310</span> <span class="o">&gt;=</span> <span class="n">vec500</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">vec500</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">vec850</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">vec850</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">15</span> <span class="ow">and</span> <span class="n">vec500</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">:</span>
        <span class="n">term5</span> <span class="o">=</span> <span class="mi">125</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">vec500</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">vec850</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">term5</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">sweat</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span> <span class="o">+</span> <span class="n">term4</span> <span class="o">+</span> <span class="n">term5</span>

    <span class="k">return</span> <span class="n">sweat</span></div>


<span class="k">def</span> <span class="nf">thetae_diff</span><span class="p">(</span><span class="n">prof</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        thetae_diff()</span>

<span class="sd">        Adapted from code for thetae_diff2() provided by Rich Thompson (SPC)</span>

<span class="sd">        Find the maximum and minimum Theta-E values in the lowest 3000 m of</span>
<span class="sd">        the sounding and returns the difference.  Only positive difference values</span>
<span class="sd">        (where the minimum Theta-E is above the maximum) are returned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prof : profile object</span>
<span class="sd">            Profile object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        thetae_diff : number</span>
<span class="sd">            the Theta-E difference between the max and min values (K)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">thetae</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s1">&#39;thetae&#39;</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">get_thetae_profile</span><span class="p">())</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">to_agl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">prof</span><span class="o">.</span><span class="n">hght</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3000</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">maxe_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">thetae</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">mine_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">thetae</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

    <span class="n">maxe_pres</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">maxe_idx</span><span class="p">]</span>
    <span class="n">mine_pres</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">mine_idx</span><span class="p">]</span>

    <span class="n">thetae_diff</span> <span class="o">=</span> <span class="n">thetae</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">maxe_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">thetae</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">mine_idx</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">maxe_pres</span> <span class="o">&lt;</span> <span class="n">mine_pres</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">thetae_diff</span>


<span class="k">def</span> <span class="nf">bore_lift</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">hbot</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">htop</span><span class="o">=</span><span class="mf">3000.</span><span class="p">,</span> <span class="n">pbot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ptop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lift all parcels in the layer. Calculate and return the difference between </span>
<span class="sd">    the liften parcel level height and the LFC height. </span>
<span class="sd">    </span>
<span class="sd">    hbot: bottom of layer in meters (AGL)</span>
<span class="sd">    htop: top of layer in meters(AGL)</span>

<span class="sd">    OR</span>

<span class="sd">    pbot: bottom of layer (in hPa)</span>
<span class="sd">    ptop: top of layer  (in hPa)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">pres</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">;</span> <span class="n">hght</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">hght</span>
    <span class="n">tmpc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="p">;</span> <span class="n">dwpc</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="o">.</span><span class="n">mask</span> <span class="o">*</span> <span class="o">~</span><span class="n">prof</span><span class="o">.</span><span class="n">hght</span><span class="o">.</span><span class="n">mask</span> <span class="o">*</span> <span class="o">~</span><span class="n">prof</span><span class="o">.</span><span class="n">tmpc</span><span class="o">.</span><span class="n">mask</span> <span class="o">*</span> <span class="o">~</span><span class="n">prof</span><span class="o">.</span><span class="n">dwpc</span><span class="o">.</span><span class="n">mask</span>

    <span class="k">if</span> <span class="n">pbot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">layer_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">pbot</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="n">prof</span><span class="o">.</span><span class="n">pres</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ptop</span> <span class="p">)</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">hbot</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">hbot</span><span class="p">)</span>
        <span class="n">htop</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">to_msl</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">htop</span><span class="p">)</span>
        <span class="n">pbot</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">hbot</span><span class="p">)</span>
        <span class="n">ptop</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">pres</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">htop</span><span class="p">)</span>
        <span class="n">layer_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span> <span class="n">prof</span><span class="o">.</span><span class="n">hght</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">hbot</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="n">prof</span><span class="o">.</span><span class="n">hght</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">htop</span> <span class="p">)</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">delta_lfc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">layer_idxs</span><span class="p">)))</span>
    <span class="n">delta_lfc</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">layer_idxs</span><span class="p">:</span>
       <span class="n">lpl</span> <span class="o">=</span> <span class="n">DefineParcel</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="n">pres</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
       <span class="n">pcl</span> <span class="o">=</span> <span class="n">parcelx</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">pres</span><span class="o">=</span><span class="n">pres</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">tmpc</span><span class="o">=</span><span class="n">tmpc</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">dwpc</span><span class="o">=</span><span class="n">dwpc</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">pbot</span><span class="o">=</span><span class="n">pres</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
       <span class="n">delta_lfc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcl</span><span class="o">.</span><span class="n">lfchght</span> <span class="o">-</span> <span class="n">hght</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
       <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>   

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">delta_lfc</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Blumberg, W.G, Halbert, K.T., Supinie, T.A., Marsh, P.T., Thompson, R., and J. Hart

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>